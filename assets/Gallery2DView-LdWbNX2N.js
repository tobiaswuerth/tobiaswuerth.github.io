import{d as de,r as U,o as fe,a as he,b as ye,e as ee,F as Ie,f as K,l as ie,i as pe,t as re,m as Ee,w as Se,p as Re,q as Ae,T as Te,v as _e,_ as me,g as Ce,u as Oe,h as be,x as se}from"./main-Ce2yCQJf.js";const Me="/2d-tutorial.webm",ce=1500,ue="gallery2d.tutorial_viewed",Le=de({__name:"Gallery2DTutorial",props:{registerOnReady:{type:Function}},setup(ne){const c=ne,b=U(null),R=U(null);let s=null,W=null,q=null,H=null,L=null,j=null;const Y=U(!1),k=U(!1);let I=!1;function te(){try{return!!localStorage.getItem(ue)}catch{return!1}}function X(){try{localStorage.setItem(ue,"1")}catch{}}function y(p,h,d,u){if(!p||!h||!d||!u){console.warn("Tutorial not starting: missing required parameters"),console.debug({viewport_:p,config_:h,worldWidth_:d,drawGrid_:u});return}console.log("2D tutorial ready"),s=p,W=h,q=d,H=u,Y.value=!0,te()||l()}async function l(){if(!b.value||!R.value){console.warn("Tutorial not starting: tutorial container or tutorial video not initialized"),console.debug({tutorialContainer:b.value,tutorialVideo:R.value});return}if(I=!1,k.value=!0,L={x:s.x,y:s.y,scale:s.scale.x},j=s.eventMode,s.eventMode="none",s.plugins.pause("decelerate"),s.plugins.pause("drag"),s.plugins.pause("pinch"),s.plugins.pause("wheel"),R.value.currentTime=0,await R.value.play(),await E(!1),I){v();return}if(await M(!1),I){v();return}if(await M(!0),I){v();return}if(await E(!0),I){v();return}X(),v()}function J(){I=!0,v(),X()}function v(){if(!b.value||!R.value){console.error("Tutorial not stopping: tutorial container or tutorial video not initialized");return}if(k.value=!1,R.value.pause(),L&&s)try{s.x=L.x,s.y=L.y,s.scale.set(L.scale)}catch{}j!==null&&s?s.eventMode=j:s.eventMode="static",s.plugins.resume("decelerate"),s.plugins.resume("drag"),s.plugins.resume("pinch"),s.plugins.resume("wheel"),H()}function E(p=!1){return new Promise(h=>{const d=s.scale.x,u=p?d/10:d*10,g=p?Math.max(W.VIEWPORT.MIN_SCALE,u):Math.min(W.VIEWPORT.MAX_SCALE,u),A={x:window.innerWidth/2,y:window.innerHeight/2},V=s.toWorld(A.x,A.y),P=g-d;if(Math.abs(P)<1e-6){h();return}const z=ce/1e3,F=Math.abs(P)/z;let D=performance.now();const B=C=>{if(I){h();return}const T=(C-D)/1e3;D=C;const $=Math.sign(P);let N=s.scale.x+$*F*T;($>0&&N>=g||$<0&&N<=g)&&(N=g),s.scale.set(N);const Z=s.toScreen(V.x,V.y);if(s.x+=A.x-Z.x,s.y+=A.y-Z.y,H(),N===g){h();return}requestAnimationFrame(B)};requestAnimationFrame(B)})}function M(p=!1){return new Promise(h=>{const d=q/1.5,u=s.x,g=p?u-d:u+d,A=g-u;if(Math.abs(A)<1e-6){h();return}const V=ce/1e3,P=Math.abs(A)/V;let z=performance.now();const F=D=>{if(I){h();return}const B=(D-z)/1e3;z=D;const C=Math.sign(A);let T=s.x+C*P*B;if((C>0&&T>=g||C<0&&T<=g)&&(T=g),s.x=T,H(),T===g){h();return}requestAnimationFrame(F)};requestAnimationFrame(F)})}return fe(()=>{if(!("ontouchstart"in window)&&navigator.maxTouchPoints<1){console.log("Skipping 2D tutorial: no touch support detected");return}c.registerOnReady(y)}),he(()=>{I=!0,v()}),(p,h)=>{const d=Ee;return ee(),ye(Ie,null,[K("div",{ref_key:"tutorialContainer",ref:b,class:Re(["tutorial",{visible:k.value}])},[K("h2",null,re(p.$t("gallery2d.tutorial")),1),K("video",{ref_key:"tutorialVideo",ref:R,muted:""},[...h[0]||(h[0]=[K("source",{src:Me,type:"video/webm"},null,-1)])],512),pe(d,{class:"tutorial-skip",onClick:J,severity:"contrast",rounded:""},{default:Se(()=>[_e(re(p.$t("gallery2d.tutorial_skip")),1)]),_:1})],2),(ee(),ie(Te,{to:"body"},[Y.value&&!k.value?(ee(),ie(d,{key:0,icon:"pi pi-question-circle",onClick:l,raised:"",text:"",rounded:"",severity:"primary",variant:"outlined","aria-label":p.$t("gallery2d.tutorial"),class:"tutorial-button"},null,8,["aria-label"])):Ae("",!0)]))],64)}}}),Pe=me(Le,[["__scopeId","data-v-55b46608"]]),De={class:"gallery-2d-container"},Ne=de({__name:"Gallery2DView",setup(ne){const c={COORDS_URL:"/gallery2d.json",BASE_SPRITE_SIZE:25,BACKGROUND:{COLOR_LIGHT:15132379,COLOR_DARK:1710618},GRID:{COLOR_LIGHT:13290186,COLOR_DARK:3355443,ALPHA_MAJOR:.5,ALPHA_MINOR:.25,MAJOR_LINE_SPACING:100,MINOR_LINE_SPACING:20},INTERACTION:{DRAG_THRESHOLD:5,PINCH_END_DELAY:200},VIEWPORT:{MIN_SCALE:.2,MAX_SCALE:75,FRICTION:.95},SPRITES:{PLACEHOLDER_COLOR:16777215,TEXTURE_SIZES:[128,256,512,1024,1536,2048]},IMAGES:{DEFAULT_SIZE:128,DEFAULT_EXT:"avif",HIGH_RES_SIZE:2048,HIGH_RES_EXT:"jpg"}};function b(e,i=c.IMAGES.DEFAULT_SIZE,t=c.IMAGES.DEFAULT_EXT){return`/gallery/${e}/${e}-${i}.${t}`}function R(e){return new Promise((i,t)=>{if(document.querySelector(`script[src="${e}"]`)){i();return}const a=document.createElement("script");a.src=e,a.async=!0,a.onload=()=>i(),a.onerror=()=>t(new Error(`Failed to load script: ${e}`)),document.head.appendChild(a)})}async function s(){await R("https://cdn.jsdelivr.net/npm/pixi.js@7.4.3/dist/pixi.min.js"),await R("https://cdn.jsdelivr.net/npm/pixi-viewport@5.1.0/dist/viewport.min.js")}const{setTitle:W,setIcon:q,resetAppBar:H}=Ce(),{enableSearch:L,setSearchResultsCallback:j,disableSearch:Y}=Oe(),{showError:k,showLoading:I,closePopup:te}=be(),X=U(null),y=se(null),l=se(null),J=U([]),v=new Map,E=new Map;let M=0,p=0,h=null,d=null,u=null;async function g(){try{I("gallery2d.loading"),await s(),await P(),await z(),F(),D(),B(),y.value.ticker.add($),te()}catch(e){console.error("Failed to initialize gallery:",e),k("gallery2d.error",e.message,!0)}}async function A(){if(window.PIXI&&window.PIXI.Assets){const e=Array.from(v.keys()).map(i=>{const[t,a]=i.split("-");return b(t,a)});e.length>0&&await window.PIXI.Assets.unload(e)}v.clear(),E.clear(),y.value&&y.value.destroy(!0,{children:!0,texture:!1,baseTexture:!1}),h&&(h.disconnect(),h=null),window.removeEventListener("resize",Z)}async function V(e){if(e.length===0){E.forEach(r=>{r.alpha=1});return}const i=new Map;e.forEach(r=>{i.set(r.imageName,r.similarity)});const t=Math.min(...i.values()),a=Math.max(...i.values());E.forEach((r,m)=>{r.alpha=(i.get(m)??0-t)/(a-t)})}async function P(){const i=document.documentElement.classList.contains("dark")?c.BACKGROUND.COLOR_DARK:c.BACKGROUND.COLOR_LIGHT;y.value=new window.PIXI.Application({width:window.innerWidth,height:window.innerHeight,backgroundColor:i,resolution:Math.max(1,Math.min(window.devicePixelRatio||1,2)),autoDensity:!0,antialias:!0,powerPreference:"high-performance",hello:!1}),X.value&&(X.value.appendChild(y.value.view),y.value.view.style.touchAction="none"),y.value.renderer.events.moveOnAll=!0,h=new MutationObserver(()=>{if(y.value&&y.value.renderer){const t=document.documentElement.classList.contains("dark");y.value.renderer.background.color=t?c.BACKGROUND.COLOR_DARK:c.BACKGROUND.COLOR_LIGHT,u&&u()}}),h.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),window.addEventListener("resize",Z)}async function z(){const i=await(await fetch(c.COORDS_URL)).json(),t=Object.entries(i).map(([n,o])=>({name:n,x:o[0],y:o[1]})),a=Math.min(...t.map(n=>n.x)),r=Math.max(...t.map(n=>n.x)),m=Math.min(...t.map(n=>n.y)),w=Math.max(...t.map(n=>n.y)),x=r-a,f=w-m,_=Math.min(window.innerWidth/x,window.innerHeight/f)*2;M=x*_,p=f*_,J.value=t.map(n=>({...n,x:(n.x-a)*_,y:(n.y-m)*_}))}function F(){l.value=new window.PIXI.Viewport({screenWidth:window.innerWidth,screenHeight:window.innerHeight,worldWidth:M,worldHeight:p,events:y.value.renderer.events}),y.value.stage.addChild(l.value);let e=!1,i=null,t=null,a=null;const r=new Map;let m=0,w=null,x=!1,f=!1;l.value.eventMode="static",l.value.hitArea=y.value.screen,l.value.on("pointerdown",n=>{if(n.pointerType==="touch")if(r.set(n.pointerId,{x:n.global.x,y:n.global.y}),r.size===2){x=!0,e=!1,a=null,l.value.plugins.pause("decelerate");const o=Array.from(r.values());m=Math.hypot(o[0].x-o[1].x,o[0].y-o[1].y),w={x:(o[0].x+o[1].x)/2,y:(o[0].y+o[1].y)/2}}else r.size===1&&!x&&(t={x:n.global.x,y:n.global.y},i={x:n.global.x,y:n.global.y},e=!1,a={x:n.global.x,y:n.global.y});else n.originalEvent.button===0&&(t={x:n.global.x,y:n.global.y},i={x:n.global.x,y:n.global.y},e=!1,a={x:n.global.x,y:n.global.y},l.value.plugins.pause("decelerate"))}),l.value.on("pointermove",n=>{if(n.pointerType==="touch"){if(!r.has(n.pointerId))return;if(r.set(n.pointerId,{x:n.global.x,y:n.global.y}),r.size===2&&x){const o=Array.from(r.values()),G=Math.hypot(o[0].x-o[1].x,o[0].y-o[1].y),O={x:(o[0].x+o[1].x)/2,y:(o[0].y+o[1].y)/2};if(m>0&&G>0&&w){const Q=O.x-w.x,S=O.y-w.y;l.value.x+=Q,l.value.y+=S;const xe=G/m,le=l.value.toWorld(O),we=l.value.scale.x,ge=Math.max(c.VIEWPORT.MIN_SCALE,Math.min(c.VIEWPORT.MAX_SCALE,we*xe));l.value.scale.set(ge);const oe=l.value.toScreen(le.x,le.y);l.value.x+=O.x-oe.x,l.value.y+=O.y-oe.y,u&&u()}m=G,w=O}else r.size===1&&!x&&!f&&(!e&&t&&Math.hypot(n.global.x-t.x,n.global.y-t.y)>c.INTERACTION.DRAG_THRESHOLD&&(e=!0,a=null),e&&i&&(l.value.x+=n.global.x-i.x,l.value.y+=n.global.y-i.y,u&&u()),i={x:n.global.x,y:n.global.y})}else if(i&&t){const o={x:n.global.x,y:n.global.y};e||Math.hypot(o.x-t.x,o.y-t.y)>c.INTERACTION.DRAG_THRESHOLD&&(e=!0,a=null),e&&(l.value.x+=o.x-i.x,l.value.y+=o.y-i.y,u&&u()),i=o}});const _=n=>{if(n.pointerType==="touch"){if(!e&&!x&&!f&&a&&r.size===1){const o=T(a.x,a.y);o&&C(o)}if(r.delete(n.pointerId),r.size<2&&x&&(x=!1,m=0,w=null,f=!0,setTimeout(()=>{f=!1},c.INTERACTION.PINCH_END_DELAY),r.size===1)){const o=r.values().next().value;o&&(t={x:o.x,y:o.y},i={x:o.x,y:o.y},e=!1,a={x:o.x,y:o.y})}r.size<1&&(e&&l.value.plugins.resume("decelerate"),e=!1,i=null,t=null,a=null,f=!1)}else if(n.originalEvent.button===0){if(!e&&a){const o=T(a.x,a.y);o&&C(o)}e&&l.value.plugins.resume("decelerate"),e=!1,i=null,t=null,a=null}};l.value.on("pointerup",_),l.value.on("pointerupoutside",_),l.value.on("pointercancel",_),l.value.wheel().decelerate({friction:c.VIEWPORT.FRICTION}),l.value.clampZoom({minScale:c.VIEWPORT.MIN_SCALE,maxScale:c.VIEWPORT.MAX_SCALE}),l.value.fit(),l.value.moveCenter(M/2,p/2)}function D(){d=new window.PIXI.Graphics,l.value.addChild(d),u=()=>{d.clear();const e=l.value.getVisibleBounds(),i=c.GRID.MAJOR_LINE_SPACING,t=c.GRID.MINOR_LINE_SPACING,a=Math.min(1,l.value.scale.x*2),r=Math.min(1,l.value.scale.x*4),w=document.documentElement.classList.contains("dark")?c.GRID.COLOR_DARK:c.GRID.COLOR_LIGHT,x=(f,_,n)=>{d.lineStyle(n/l.value.scale.x,w,_);const o=Math.floor(e.x/f)*f,G=Math.ceil((e.x+e.width)/f)*f,O=Math.floor(e.y/f)*f,Q=Math.ceil((e.y+e.height)/f)*f;for(let S=o;S<G;S+=f)d.moveTo(S,O),d.lineTo(S,Q);for(let S=O;S<Q;S+=f)d.moveTo(o,S),d.lineTo(G,S)};r>.1&&x(t,r,c.GRID.ALPHA_MINOR),a>.05&&x(i,a,c.GRID.ALPHA_MAJOR)},l.value.on("moved",u),u()}function B(){const e=new window.PIXI.Graphics().beginFill(c.SPRITES.PLACEHOLDER_COLOR).drawRect(0,0,128,128).endFill(),i=y.value.renderer.generateTexture(e);J.value.forEach(t=>{const a=new window.PIXI.Sprite(i);a.anchor.set(.5),a.width=c.BASE_SPRITE_SIZE,a.height=c.BASE_SPRITE_SIZE,a.x=t.x,a.y=t.y,a.eventMode="none",a.name=t.name,l.value.addChild(a),E.set(t.name,a)})}function C(e){if(e&&e.name){const i=b(e.name,c.IMAGES.HIGH_RES_SIZE,c.IMAGES.HIGH_RES_EXT);window.open(i,"_blank")}else console.warn("Click handler called with invalid sprite:",e)}function T(e,i){for(const t of E.values())if(t.getBounds().contains(e,i))return t;return null}function $(){if(!l.value)return;const e=l.value.getVisibleBounds(),i=l.value.scale.x;E.forEach((t,a)=>{const r=t.x>e.x-t.width/2&&t.x<e.x+e.width+t.width/2&&t.y>e.y-t.height/2&&t.y<e.y+e.height+t.height/2;if(t.visible=r,r){const m=c.BASE_SPRITE_SIZE*i,w=c.SPRITES.TEXTURE_SIZES,x=w.find(f=>f>=m)||w[w.length-1];N(a,x)}})}async function N(e,i){const t=`${e}-${i}`;if(v.has(t)){const r=E.get(e);r&&r.texture!==v.get(t)&&(r.texture=v.get(t));return}const a=b(e,i);try{const r=await window.PIXI.Assets.load(a);v.set(t,r);const m=E.get(e);m&&(m.texture=r)}catch(r){console.warn(`Could not load texture: ${a}`,r),v.set(t,null)}}function Z(){!y.value||!l.value||(y.value.renderer.resize(window.innerWidth,window.innerHeight),l.value.resize(window.innerWidth,window.innerHeight,M,p))}let ae=null;function ve(e){ae=e}return fe(async()=>{W("gallery2d.title"),q("pi pi-hashtag"),await g(),L(),j(V),ae?.(l.value,c,M,u)}),he(()=>{H(),Y(),A()}),(e,i)=>(ee(),ye("div",De,[pe(Pe,{registerOnReady:ve}),K("div",{ref_key:"canvasContainer",ref:X,class:"gallery-canvas"},null,512)]))}}),He=me(Ne,[["__scopeId","data-v-bea9cf31"]]);export{He as default};
