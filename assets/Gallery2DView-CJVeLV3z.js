import{d as he,r as U,o as ve,a as me,b as le,e as Q,F as Se,f as N,l as ue,m as ce,i as xe,t as oe,p as de,q as _e,w as Re,T as Ae,v as Te,_ as we,g as Ce,u as Oe,h as be,x as fe}from"./main-Ba4-J7bK.js";const Me="/2d-tutorial.webm",Pe="/2d-tutorial-iOS.mov",Le={key:0,class:"no-video"},De={class:"no-video-hint"},pe=1500,ye="gallery2d.tutorial_viewed",Ne=he({__name:"Gallery2DTutorial",props:{registerOnReady:{type:Function}},setup(ie){const u=ie,M=U(null),_=U(null),G=U(!0);let s=null,q=null,ee=null,B=null,k=null,Y=null;const te=U(!1),W=U(!1);let g=!1;function J(){try{return!!localStorage.getItem(ye)}catch{return!1}}function f(){try{localStorage.setItem(ye,"1")}catch{}}function o(c,p,h,w){if(!c||!p||!h||!w){console.warn("Tutorial not starting: missing required parameters"),console.debug({viewport_:c,config_:p,worldWidth_:h,drawGrid_:w});return}console.log("2D tutorial ready"),s=c,q=p,ee=h,B=w,te.value=!0,J()||I()}function ne(){console.warn("Tutorial video: error loading/playing source"),G.value=!0}function C(){G.value=!1}async function I(){if(!M.value||!_.value){console.warn("Tutorial not starting: tutorial container or tutorial video not initialized"),console.debug({tutorialContainer:M.value,tutorialVideo:_.value});return}g=!1,W.value=!0,k={x:s.x,y:s.y,scale:s.scale.x},Y=s.eventMode,s.eventMode="none",s.plugins.pause("decelerate"),s.plugins.pause("drag"),s.plugins.pause("pinch"),s.plugins.pause("wheel"),_.value.currentTime=0;try{await _.value.play()}catch(c){return console.warn("Tutorial video cannot be played:",c),G.value=!0,O()}await P(!1),!g&&(await E(!1),!g&&(await E(!0),!g&&(await P(!0),!g&&(f(),O()))))}function H(){g=!0,O(),f()}function O(){if(!M.value||!_.value){console.error("Tutorial not stopping: tutorial container or tutorial video not initialized");return}if(W.value=!1,_.value.pause(),k&&s)try{s.x=k.x,s.y=k.y,s.scale.set(k.scale)}catch{}Y!==null&&s?s.eventMode=Y:s.eventMode="static",s.plugins.resume("decelerate"),s.plugins.resume("drag"),s.plugins.resume("pinch"),s.plugins.resume("wheel"),B()}function P(c=!1){return new Promise(p=>{const h=s.scale.x,w=c?h/10:h*10,x=c?Math.max(q.VIEWPORT.MIN_SCALE,w):Math.min(q.VIEWPORT.MAX_SCALE,w),R={x:window.innerWidth/2,y:window.innerHeight/2},$=s.toWorld(R.x,R.y),X=x-h;if(Math.abs(X)<1e-6){p();return}const j=pe/1e3,V=Math.abs(X)/j;let L=performance.now();const Z=D=>{if(g){p();return}const A=(D-L)/1e3;L=D;const K=Math.sign(X);let z=s.scale.x+K*V*A;(K>0&&z>=x||K<0&&z<=x)&&(z=x),s.scale.set(z);const e=s.toScreen($.x,$.y);if(s.x+=R.x-e.x,s.y+=R.y-e.y,B(),z===x){p();return}requestAnimationFrame(Z)};requestAnimationFrame(Z)})}function E(c=!1){return new Promise(p=>{const h=ee/1.5,w=s.x,x=c?w-h:w+h,R=x-w;if(Math.abs(R)<1e-6){p();return}const $=pe/1e3,X=Math.abs(R)/$;let j=performance.now();const V=L=>{if(g){p();return}const Z=(L-j)/1e3;j=L;const D=Math.sign(R);let A=s.x+D*X*Z;if((D>0&&A>=x||D<0&&A<=x)&&(A=x),s.x=A,B(),A===x){p();return}requestAnimationFrame(V)};requestAnimationFrame(V)})}return ve(()=>{if(!("ontouchstart"in window)&&navigator.maxTouchPoints<1){console.log("Skipping 2D tutorial: no touch support detected");return}u.registerOnReady(o)}),me(()=>{g=!0,O()}),(c,p)=>{const h=_e;return Q(),le(Se,null,[N("div",{ref_key:"tutorialContainer",ref:M,class:de(["tutorial",{hide:!W.value}])},[N("h2",null,oe(c.$t("gallery2d.tutorial")),1),N("video",{ref_key:"tutorialVideo",ref:_,muted:"",preload:"metadata",onError:ne,onCanplay:C,class:de({hide:G.value})},[...p[0]||(p[0]=[N("source",{src:Me,type:"video/webm"},null,-1),N("source",{src:Pe,type:"video/quicktime"},null,-1)])],34),G.value?(Q(),le("div",Le,[N("div",De,oe(c.$t("gallery2d.tutorial_novideo")),1),N("p",null,oe(c.$t("gallery2d.tutorial_novideo_explain")),1)])):ce("",!0),xe(h,{class:"tutorial-skip",onClick:H,severity:"contrast",rounded:""},{default:Re(()=>[Te(oe(c.$t("gallery2d.tutorial_skip")),1)]),_:1})],2),(Q(),ue(Ae,{to:"body"},[te.value&&!W.value?(Q(),ue(h,{key:0,icon:"pi pi-question-circle",onClick:I,raised:"",text:"",rounded:"",severity:"primary",variant:"outlined","aria-label":c.$t("gallery2d.tutorial"),class:"tutorial-button"},null,8,["aria-label"])):ce("",!0)]))],64)}}}),Ge=we(Ne,[["__scopeId","data-v-8b573b7c"]]),ke={class:"gallery-2d-container"},He=he({__name:"Gallery2DView",setup(ie){const u={COORDS_URL:"/gallery2d.json",BASE_SPRITE_SIZE:25,BACKGROUND:{COLOR_LIGHT:15132379,COLOR_DARK:1710618},GRID:{COLOR_LIGHT:13290186,COLOR_DARK:3355443,ALPHA_MAJOR:.5,ALPHA_MINOR:.25,MAJOR_LINE_SPACING:100,MINOR_LINE_SPACING:20},INTERACTION:{DRAG_THRESHOLD:5,PINCH_END_DELAY:200},VIEWPORT:{MIN_SCALE:.2,MAX_SCALE:75,FRICTION:.95},SPRITES:{PLACEHOLDER_COLOR:16777215,TEXTURE_SIZES:[128,256,512,1024,1536,2048]},IMAGES:{DEFAULT_SIZE:128,DEFAULT_EXT:"avif",HIGH_RES_SIZE:2048,HIGH_RES_EXT:"jpg"}};function M(e,i=u.IMAGES.DEFAULT_SIZE,t=u.IMAGES.DEFAULT_EXT){return`/gallery/${e}/${e}-${i}.${t}`}function _(e){return new Promise((i,t)=>{if(document.querySelector(`script[src="${e}"]`)){i();return}const a=document.createElement("script");a.src=e,a.async=!0,a.onload=()=>i(),a.onerror=()=>t(new Error(`Failed to load script: ${e}`)),document.head.appendChild(a)})}async function G(){await _("https://cdn.jsdelivr.net/npm/pixi.js@7.4.3/dist/pixi.min.js"),await _("https://cdn.jsdelivr.net/npm/pixi-viewport@5.1.0/dist/viewport.min.js")}const{setTitle:s,setIcon:q,resetAppBar:ee}=Ce(),{enableSearch:B,setSearchResultsCallback:k,disableSearch:Y}=Oe(),{showError:te,showLoading:W,closePopup:g}=be(),J=U(null),f=fe(null),o=fe(null),ne=U([]),C=new Map,I=new Map;let H=0,O=0,P=null,E=null,c=null;async function p(){try{W("gallery2d.loading"),await G(),await x(),await R(),$(),X(),j(),f.value.ticker.add(Z),g()}catch(e){console.error("Failed to initialize gallery:",e),te("gallery2d.error",e.message,!0)}}async function h(){if(window.PIXI&&window.PIXI.Assets){const e=Array.from(C.keys()).map(i=>{const[t,a]=i.split("-");return M(t,a)});e.length>0&&await window.PIXI.Assets.unload(e)}C.clear(),I.clear(),f.value&&f.value.destroy(!0,{children:!0,texture:!1,baseTexture:!1}),P&&(P.disconnect(),P=null),window.removeEventListener("resize",A)}async function w(e){if(e.length===0){I.forEach(r=>{r.alpha=1});return}const i=new Map;e.forEach(r=>{i.set(r.imageName,r.similarity)});const t=Math.min(...i.values()),a=Math.max(...i.values());I.forEach((r,y)=>{r.alpha=(i.get(y)??0-t)/(a-t)})}async function x(){const i=document.documentElement.classList.contains("dark")?u.BACKGROUND.COLOR_DARK:u.BACKGROUND.COLOR_LIGHT;f.value=new window.PIXI.Application({width:window.innerWidth,height:window.innerHeight,backgroundColor:i,resolution:Math.max(1,Math.min(window.devicePixelRatio||1,2)),autoDensity:!0,antialias:!0,powerPreference:"high-performance",hello:!1}),J.value&&(J.value.appendChild(f.value.view),f.value.view.style.touchAction="none"),f.value.renderer.events.moveOnAll=!0,P=new MutationObserver(()=>{if(f.value&&f.value.renderer){const t=document.documentElement.classList.contains("dark");f.value.renderer.background.color=t?u.BACKGROUND.COLOR_DARK:u.BACKGROUND.COLOR_LIGHT,c&&c()}}),P.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),window.addEventListener("resize",A)}async function R(){const i=await(await fetch(u.COORDS_URL)).json(),t=Object.entries(i).map(([n,l])=>({name:n,x:l[0],y:l[1]})),a=Math.min(...t.map(n=>n.x)),r=Math.max(...t.map(n=>n.x)),y=Math.min(...t.map(n=>n.y)),m=Math.max(...t.map(n=>n.y)),v=r-a,d=m-y,T=Math.min(window.innerWidth/v,window.innerHeight/d)*2;H=v*T,O=d*T,ne.value=t.map(n=>({...n,x:(n.x-a)*T,y:(n.y-y)*T}))}function $(){o.value=new window.PIXI.Viewport({screenWidth:window.innerWidth,screenHeight:window.innerHeight,worldWidth:H,worldHeight:O,events:f.value.renderer.events}),f.value.stage.addChild(o.value);let e=!1,i=null,t=null,a=null;const r=new Map;let y=0,m=null,v=!1,d=!1;o.value.eventMode="static",o.value.hitArea=f.value.screen,o.value.on("pointerdown",n=>{if(n.pointerType==="touch")if(r.set(n.pointerId,{x:n.global.x,y:n.global.y}),r.size===2){v=!0,e=!1,a=null,o.value.plugins.pause("decelerate");const l=Array.from(r.values());y=Math.hypot(l[0].x-l[1].x,l[0].y-l[1].y),m={x:(l[0].x+l[1].x)/2,y:(l[0].y+l[1].y)/2}}else r.size===1&&!v&&(t={x:n.global.x,y:n.global.y},i={x:n.global.x,y:n.global.y},e=!1,a={x:n.global.x,y:n.global.y});else n.originalEvent.button===0&&(t={x:n.global.x,y:n.global.y},i={x:n.global.x,y:n.global.y},e=!1,a={x:n.global.x,y:n.global.y},o.value.plugins.pause("decelerate"))}),o.value.on("pointermove",n=>{if(n.pointerType==="touch"){if(!r.has(n.pointerId))return;if(r.set(n.pointerId,{x:n.global.x,y:n.global.y}),r.size===2&&v){const l=Array.from(r.values()),F=Math.hypot(l[0].x-l[1].x,l[0].y-l[1].y),b={x:(l[0].x+l[1].x)/2,y:(l[0].y+l[1].y)/2};if(y>0&&F>0&&m){const ae=b.x-m.x,S=b.y-m.y;o.value.x+=ae,o.value.y+=S;const ge=F/y,re=o.value.toWorld(b),Ie=o.value.scale.x,Ee=Math.max(u.VIEWPORT.MIN_SCALE,Math.min(u.VIEWPORT.MAX_SCALE,Ie*ge));o.value.scale.set(Ee);const se=o.value.toScreen(re.x,re.y);o.value.x+=b.x-se.x,o.value.y+=b.y-se.y,c&&c()}y=F,m=b}else r.size===1&&!v&&!d&&(!e&&t&&Math.hypot(n.global.x-t.x,n.global.y-t.y)>u.INTERACTION.DRAG_THRESHOLD&&(e=!0,a=null),e&&i&&(o.value.x+=n.global.x-i.x,o.value.y+=n.global.y-i.y,c&&c()),i={x:n.global.x,y:n.global.y})}else if(i&&t){const l={x:n.global.x,y:n.global.y};e||Math.hypot(l.x-t.x,l.y-t.y)>u.INTERACTION.DRAG_THRESHOLD&&(e=!0,a=null),e&&(o.value.x+=l.x-i.x,o.value.y+=l.y-i.y,c&&c()),i=l}});const T=n=>{if(n.pointerType==="touch"){if(!e&&!v&&!d&&a&&r.size===1){const l=L(a.x,a.y);l&&V(l)}if(r.delete(n.pointerId),r.size<2&&v&&(v=!1,y=0,m=null,d=!0,setTimeout(()=>{d=!1},u.INTERACTION.PINCH_END_DELAY),r.size===1)){const l=r.values().next().value;l&&(t={x:l.x,y:l.y},i={x:l.x,y:l.y},e=!1,a={x:l.x,y:l.y})}r.size<1&&(e&&o.value.plugins.resume("decelerate"),e=!1,i=null,t=null,a=null,d=!1)}else if(n.originalEvent.button===0){if(!e&&a){const l=L(a.x,a.y);l&&V(l)}e&&o.value.plugins.resume("decelerate"),e=!1,i=null,t=null,a=null}};o.value.on("pointerup",T),o.value.on("pointerupoutside",T),o.value.on("pointercancel",T),o.value.wheel().decelerate({friction:u.VIEWPORT.FRICTION}),o.value.clampZoom({minScale:u.VIEWPORT.MIN_SCALE,maxScale:u.VIEWPORT.MAX_SCALE}),o.value.fit(),o.value.moveCenter(H/2,O/2)}function X(){E=new window.PIXI.Graphics,o.value.addChild(E),c=()=>{E.clear();const e=o.value.getVisibleBounds(),i=u.GRID.MAJOR_LINE_SPACING,t=u.GRID.MINOR_LINE_SPACING,a=Math.min(1,o.value.scale.x*2),r=Math.min(1,o.value.scale.x*4),m=document.documentElement.classList.contains("dark")?u.GRID.COLOR_DARK:u.GRID.COLOR_LIGHT,v=(d,T,n)=>{E.lineStyle(n/o.value.scale.x,m,T);const l=Math.floor(e.x/d)*d,F=Math.ceil((e.x+e.width)/d)*d,b=Math.floor(e.y/d)*d,ae=Math.ceil((e.y+e.height)/d)*d;for(let S=l;S<F;S+=d)E.moveTo(S,b),E.lineTo(S,ae);for(let S=b;S<ae;S+=d)E.moveTo(l,S),E.lineTo(F,S)};r>.1&&v(t,r,u.GRID.ALPHA_MINOR),a>.05&&v(i,a,u.GRID.ALPHA_MAJOR)},o.value.on("moved",c),c()}function j(){const e=new window.PIXI.Graphics().beginFill(u.SPRITES.PLACEHOLDER_COLOR).drawRect(0,0,128,128).endFill(),i=f.value.renderer.generateTexture(e);ne.value.forEach(t=>{const a=new window.PIXI.Sprite(i);a.anchor.set(.5),a.width=u.BASE_SPRITE_SIZE,a.height=u.BASE_SPRITE_SIZE,a.x=t.x,a.y=t.y,a.eventMode="none",a.name=t.name,o.value.addChild(a),I.set(t.name,a)})}function V(e){if(e&&e.name){const i=M(e.name,u.IMAGES.HIGH_RES_SIZE,u.IMAGES.HIGH_RES_EXT);window.open(i,"_blank")}else console.warn("Click handler called with invalid sprite:",e)}function L(e,i){for(const t of I.values())if(t.getBounds().contains(e,i))return t;return null}function Z(){if(!o.value)return;const e=o.value.getVisibleBounds(),i=o.value.scale.x;I.forEach((t,a)=>{const r=t.x>e.x-t.width/2&&t.x<e.x+e.width+t.width/2&&t.y>e.y-t.height/2&&t.y<e.y+e.height+t.height/2;if(t.visible=r,r){const y=u.BASE_SPRITE_SIZE*i,m=u.SPRITES.TEXTURE_SIZES,v=m.find(d=>d>=y)||m[m.length-1];D(a,v)}})}async function D(e,i){const t=`${e}-${i}`;if(C.has(t)){const r=I.get(e);r&&r.texture!==C.get(t)&&(r.texture=C.get(t));return}const a=M(e,i);try{const r=await window.PIXI.Assets.load(a);C.set(t,r);const y=I.get(e);y&&(y.texture=r)}catch(r){console.warn(`Could not load texture: ${a}`,r),C.set(t,null)}}function A(){!f.value||!o.value||(f.value.renderer.resize(window.innerWidth,window.innerHeight),o.value.resize(window.innerWidth,window.innerHeight,H,O))}let K=null;function z(e){K=e}return ve(async()=>{s("gallery2d.title"),q("pi pi-hashtag"),await p(),B(),k(w),K?.(o.value,u,H,c)}),me(()=>{ee(),Y(),h()}),(e,i)=>(Q(),le("div",ke,[xe(Ge,{registerOnReady:z}),N("div",{ref_key:"canvasContainer",ref:J,class:"gallery-canvas"},null,512)]))}}),Ve=we(He,[["__scopeId","data-v-bea9cf31"]]);export{Ve as default};
