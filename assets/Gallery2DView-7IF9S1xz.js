import{d as he,a as ye,b as fe,u as ve,r as A,m as B,o as xe,c as Ie,e as U,f as P,h as z,i as pe,j as b,g as we,p as V,t as W,k as me,l as Ee,_ as ge}from"./main-D_frdEHf.js";import{s as _e,a as Re}from"./index-DBYKmIrQ.js";const Se={class:"gallery-2d-container"},Ae={key:0,class:"loading-overlay"},Te={class:"loading-content"},Oe=he({__name:"Gallery2DView",setup(Ce){const r={COORDS_URL:"/gallery2d.json",BASE_SPRITE_SIZE:25,BACKGROUND:{COLOR_LIGHT:15132379,COLOR_DARK:1710618},GRID:{COLOR_LIGHT:13290186,COLOR_DARK:3355443,ALPHA_MAJOR:.5,ALPHA_MINOR:.25,MAJOR_LINE_SPACING:100,MINOR_LINE_SPACING:20},INTERACTION:{DRAG_THRESHOLD:5,PINCH_END_DELAY:200},VIEWPORT:{MIN_SCALE:.2,MAX_SCALE:75,FRICTION:.95},SPRITES:{PLACEHOLDER_COLOR:16777215,TEXTURE_SIZES:[128,256,512,1024,1536,2048]},IMAGES:{DEFAULT_SIZE:128,DEFAULT_EXT:"avif",HIGH_RES_SIZE:2048,HIGH_RES_EXT:"jpg"}};function T(e,i=r.IMAGES.DEFAULT_SIZE,n=r.IMAGES.DEFAULT_EXT){return`/gallery/${e}/${e}-${i}.${n}`}function D(e){return new Promise((i,n)=>{if(document.querySelector(`script[src="${e}"]`)){i();return}const t=document.createElement("script");t.src=e,t.async=!0,t.onload=()=>i(),t.onerror=()=>n(new Error(`Failed to load script: ${e}`)),document.head.appendChild(t)})}async function j(){await D("https://cdn.jsdelivr.net/npm/pixi.js@7.4.3/dist/pixi.min.js"),await D("https://cdn.jsdelivr.net/npm/pixi-viewport@5.1.0/dist/viewport.min.js")}const{t:F}=ye(),{setTitle:Z,setIcon:$,resetAppBar:K}=fe(),{enableSearch:Y,setSearchResultsCallback:J,resetSearch:q}=ve(),O=A(null),C=A(!0),L=A(""),u=B(null),o=B(null),M=A([]),m=new Map,p=new Map;let _=0,R=0,g=null,w=null,f=null;async function Q(){try{C.value=!0,await j(),await ne(),await ae(),le(),oe(),ie(),u.value.ticker.add(se)}catch(e){console.error("Failed to initialize gallery:",e),L.value=F("gallery2d.error",{error:e.message})}finally{C.value=!1}}async function ee(){if(window.PIXI&&window.PIXI.Assets){const e=Array.from(m.keys()).map(i=>{const[n,t]=i.split("-");return T(n,t)});e.length>0&&await window.PIXI.Assets.unload(e)}m.clear(),p.clear(),u.value&&u.value.destroy(!0,{children:!0,texture:!0,baseTexture:!0}),g&&(g.disconnect(),g=null),window.removeEventListener("resize",H)}async function te(e){if(e.length===0){p.forEach(t=>{t.alpha=1});return}const i=new Map;e.forEach(t=>{i.set(t.imageName,t.similarity)});const n=e.reduce((t,s)=>s.similarity>t?s.similarity:t,0);p.forEach((t,s)=>{const d=i.get(s);t.alpha=d/n})}async function ne(){const i=document.documentElement.classList.contains("dark")?r.BACKGROUND.COLOR_DARK:r.BACKGROUND.COLOR_LIGHT;u.value=new window.PIXI.Application({width:window.innerWidth,height:window.innerHeight,backgroundColor:i,resolution:Math.max(1,Math.min(window.devicePixelRatio||1,2)),autoDensity:!0,antialias:!0,powerPreference:"high-performance",hello:!1}),O.value&&(O.value.appendChild(u.value.view),u.value.view.style.touchAction="none"),u.value.renderer.events.moveOnAll=!0,g=new MutationObserver(()=>{if(u.value&&u.value.renderer){const n=document.documentElement.classList.contains("dark");u.value.renderer.background.color=n?r.BACKGROUND.COLOR_DARK:r.BACKGROUND.COLOR_LIGHT,f&&f()}}),g.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),window.addEventListener("resize",H)}async function ae(){const i=await(await fetch(r.COORDS_URL)).json(),n=Object.entries(i).map(([a,l])=>({name:a,x:l[0],y:l[1]})),t=Math.min(...n.map(a=>a.x)),s=Math.max(...n.map(a=>a.x)),d=Math.min(...n.map(a=>a.y)),y=Math.max(...n.map(a=>a.y)),h=s-t,c=y-d,x=Math.min(window.innerWidth/h,window.innerHeight/c)*2;_=h*x,R=c*x,M.value=n.map(a=>({...a,x:(a.x-t)*x,y:(a.y-d)*x}))}function le(){o.value=new window.PIXI.Viewport({screenWidth:window.innerWidth,screenHeight:window.innerHeight,worldWidth:_,worldHeight:R,events:u.value.renderer.events}),u.value.stage.addChild(o.value);let e=!1,i=null,n=null,t=null;const s=new Map;let d=0,y=null,h=!1,c=!1;o.value.eventMode="static",o.value.hitArea=u.value.screen,o.value.on("pointerdown",a=>{if(a.pointerType==="touch")if(s.set(a.pointerId,{x:a.global.x,y:a.global.y}),s.size===2){h=!0,e=!1,t=null,o.value.plugins.pause("decelerate");const l=Array.from(s.values());d=Math.hypot(l[0].x-l[1].x,l[0].y-l[1].y),y={x:(l[0].x+l[1].x)/2,y:(l[0].y+l[1].y)/2}}else s.size===1&&!h&&(n={x:a.global.x,y:a.global.y},i={x:a.global.x,y:a.global.y},e=!1,t={x:a.global.x,y:a.global.y});else a.originalEvent.button===0&&(n={x:a.global.x,y:a.global.y},i={x:a.global.x,y:a.global.y},e=!1,t={x:a.global.x,y:a.global.y},o.value.plugins.pause("decelerate"))}),o.value.on("pointermove",a=>{if(a.pointerType==="touch"){if(!s.has(a.pointerId))return;if(s.set(a.pointerId,{x:a.global.x,y:a.global.y}),s.size===2&&h){const l=Array.from(s.values()),E=Math.hypot(l[0].x-l[1].x,l[0].y-l[1].y),I={x:(l[0].x+l[1].x)/2,y:(l[0].y+l[1].y)/2};if(d>0&&E>0&&y){const S=I.x-y.x,v=I.y-y.y;o.value.x+=S,o.value.y+=v;const ce=E/d,k=o.value.toWorld(I),ue=o.value.scale.x,de=Math.max(r.VIEWPORT.MIN_SCALE,Math.min(r.VIEWPORT.MAX_SCALE,ue*ce));o.value.scale.set(de);const X=o.value.toScreen(k.x,k.y);o.value.x+=I.x-X.x,o.value.y+=I.y-X.y,f&&f()}d=E,y=I}else s.size===1&&!h&&!c&&(!e&&n&&Math.hypot(a.global.x-n.x,a.global.y-n.y)>r.INTERACTION.DRAG_THRESHOLD&&(e=!0,t=null),e&&i&&(o.value.x+=a.global.x-i.x,o.value.y+=a.global.y-i.y,f&&f()),i={x:a.global.x,y:a.global.y})}else if(i&&n){const l={x:a.global.x,y:a.global.y};e||Math.hypot(l.x-n.x,l.y-n.y)>r.INTERACTION.DRAG_THRESHOLD&&(e=!0,t=null),e&&(o.value.x+=l.x-i.x,o.value.y+=l.y-i.y,f&&f()),i=l}});const x=a=>{if(a.pointerType==="touch"){if(!e&&!h&&!c&&t&&s.size===1){const l=N(t.x,t.y);l&&G(l)}if(s.delete(a.pointerId),s.size<2&&h&&(h=!1,d=0,y=null,c=!0,setTimeout(()=>{c=!1},r.INTERACTION.PINCH_END_DELAY),s.size===1)){const l=s.values().next().value;l&&(n={x:l.x,y:l.y},i={x:l.x,y:l.y},e=!1,t={x:l.x,y:l.y})}s.size<1&&(e&&o.value.plugins.resume("decelerate"),e=!1,i=null,n=null,t=null,c=!1)}else if(a.originalEvent.button===0){if(!e&&t){const l=N(t.x,t.y);l&&G(l)}e&&o.value.plugins.resume("decelerate"),e=!1,i=null,n=null,t=null}};o.value.on("pointerup",x),o.value.on("pointerupoutside",x),o.value.on("pointercancel",x),o.value.wheel().decelerate({friction:r.VIEWPORT.FRICTION}),o.value.clampZoom({minScale:r.VIEWPORT.MIN_SCALE,maxScale:r.VIEWPORT.MAX_SCALE}),o.value.fit(),o.value.moveCenter(_/2,R/2)}function oe(){w=new window.PIXI.Graphics,o.value.addChild(w),f=()=>{w.clear();const e=o.value.getVisibleBounds(),i=r.GRID.MAJOR_LINE_SPACING,n=r.GRID.MINOR_LINE_SPACING,t=Math.min(1,o.value.scale.x*2),s=Math.min(1,o.value.scale.x*4),y=document.documentElement.classList.contains("dark")?r.GRID.COLOR_DARK:r.GRID.COLOR_LIGHT,h=(c,x,a)=>{w.lineStyle(a/o.value.scale.x,y,x);const l=Math.floor(e.x/c)*c,E=Math.ceil((e.x+e.width)/c)*c,I=Math.floor(e.y/c)*c,S=Math.ceil((e.y+e.height)/c)*c;for(let v=l;v<E;v+=c)w.moveTo(v,I),w.lineTo(v,S);for(let v=I;v<S;v+=c)w.moveTo(l,v),w.lineTo(E,v)};s>.1&&h(n,s,r.GRID.ALPHA_MINOR),t>.05&&h(i,t,r.GRID.ALPHA_MAJOR)},o.value.on("moved",f),f()}function ie(){const e=new window.PIXI.Graphics().beginFill(r.SPRITES.PLACEHOLDER_COLOR).drawRect(0,0,128,128).endFill(),i=u.value.renderer.generateTexture(e);M.value.forEach(n=>{const t=new window.PIXI.Sprite(i);t.anchor.set(.5),t.width=r.BASE_SPRITE_SIZE,t.height=r.BASE_SPRITE_SIZE,t.x=n.x,t.y=n.y,t.eventMode="none",t.name=n.name,o.value.addChild(t),p.set(n.name,t)})}function G(e){if(e&&e.name){const i=T(e.name,r.IMAGES.HIGH_RES_SIZE,r.IMAGES.HIGH_RES_EXT);window.open(i,"_blank")}else console.warn("Click handler called with invalid sprite:",e)}function N(e,i){for(const n of p.values())if(n.getBounds().contains(e,i))return n;return null}function se(){if(!o.value)return;const e=o.value.getVisibleBounds(),i=o.value.scale.x;p.forEach((n,t)=>{const s=n.x>e.x-n.width/2&&n.x<e.x+e.width+n.width/2&&n.y>e.y-n.height/2&&n.y<e.y+e.height+n.height/2;if(n.visible=s,s){const d=r.BASE_SPRITE_SIZE*i,y=r.SPRITES.TEXTURE_SIZES,h=y.find(c=>c>=d)||y[y.length-1];re(t,h)}})}async function re(e,i){const n=`${e}-${i}`;if(m.has(n)){const s=p.get(e);s&&s.texture!==m.get(n)&&(s.texture=m.get(n));return}const t=T(e,i);try{const s=await window.PIXI.Assets.load(t);m.set(n,s);const d=p.get(e);d&&(d.texture=s)}catch(s){console.warn(`Could not load texture: ${t}`,s),m.set(n,null)}}function H(){!u.value||!o.value||(u.value.renderer.resize(window.innerWidth,window.innerHeight),o.value.resize(window.innerWidth,window.innerHeight,_,R))}return xe(()=>{Z("gallery2d.title"),$("pi pi-hashtag"),Y(),J(te),Q()}),Ie(()=>{K(),q(),ee()}),(e,i)=>(P(),U("div",Se,[C.value?(P(),U("div",Ae,[b("div",Te,[we(V(_e),{style:{width:"50px",height:"50px"},strokeWidth:"6"}),b("h4",null,W(e.$t("gallery2d.loading")),1)])])):z("",!0),L.value?(P(),pe(V(Re),{key:1,severity:"error",closable:!1,class:"error-message"},{default:me(()=>[Ee(W(L.value),1)]),_:1})):z("",!0),b("div",{ref_key:"canvasContainer",ref:O,class:"gallery-canvas"},null,512)]))}}),be=ge(Oe,[["__scopeId","data-v-95ef61ed"]]);export{be as default};
