import{d as he,r as N,o as ve,a as me,b as le,e as Q,F as Se,f as Z,l as se,m as ue,i as xe,t as ce,p as de,q as Re,w as _e,T as Ae,v as Te,_ as ge,g as Ce,u as Oe,h as be,x as fe}from"./main-DGXOq_dG.js";const Me="/2d-tutorial.webm",Le="/2d-tutorial-alt.png",Pe={key:0},pe=1500,ye="gallery2d.tutorial_viewed",De=he({__name:"Gallery2DTutorial",props:{registerOnReady:{type:Function}},setup(oe){const u=oe,P=N(null),R=N(null),F=N(null),C=N(!0);let s=null,K=null,ee=null,U=null,G=null,q=null;const te=N(!1),B=N(!1);let g=!1;function f(){try{return!!localStorage.getItem(ye)}catch{return!1}}function l(){try{localStorage.setItem(ye,"1")}catch{}}function ne(p,y,m,I){if(!p||!y||!m||!I){console.warn("Tutorial not starting: missing required parameters"),console.debug({viewport_:p,config_:y,worldWidth_:m,drawGrid_:I});return}console.log("2D tutorial ready"),s=p,K=y,ee=m,U=I,te.value=!0,f()||D()}function O(){console.warn("Tutorial video: error loading/playing source"),C.value=!0}function _(){C.value=!1}async function D(){if(!P.value||!R.value){console.warn("Tutorial not starting: tutorial container or tutorial video not initialized"),console.debug({tutorialContainer:P.value,tutorialVideo:R.value});return}if(g=!1,B.value=!0,G={x:s.x,y:s.y,scale:s.scale.x},q=s.eventMode,s.eventMode="none",s.plugins.pause("decelerate"),s.plugins.pause("drag"),s.plugins.pause("pinch"),s.plugins.pause("wheel"),!C.value)try{R.value.currentTime=0,await R.value.play()}catch(p){console.warn("Tutorial video cannot be played:",p),C.value=!0}C.value&&F.value&&(F.value.src="",F.value.src="/2d-tutorial-alt.png"),await E(!1),!g&&(await v(!1),!g&&(await v(!0),!g&&(await E(!0),!g&&(l(),b()))))}function W(){g=!0,b(),l()}function b(){if(!P.value||!R.value){console.error("Tutorial not stopping: tutorial container or tutorial video not initialized");return}if(B.value=!1,R.value.pause(),G&&s)try{s.x=G.x,s.y=G.y,s.scale.set(G.scale)}catch{}q!==null&&s?s.eventMode=q:s.eventMode="static",s.plugins.resume("decelerate"),s.plugins.resume("drag"),s.plugins.resume("pinch"),s.plugins.resume("wheel"),U()}function E(p=!1){return new Promise(y=>{const m=s.scale.x,I=p?m/10:m*10,w=p?Math.max(K.VIEWPORT.MIN_SCALE,I):Math.min(K.VIEWPORT.MAX_SCALE,I),A={x:window.innerWidth/2,y:window.innerHeight/2},$=s.toWorld(A.x,A.y),k=w-m;if(Math.abs(k)<1e-6){y();return}const H=pe/1e3,X=Math.abs(k)/H;let V=performance.now();const j=M=>{if(g){y();return}const T=(M-V)/1e3;V=M;const Y=Math.sign(k);let e=s.scale.x+Y*X*T;(Y>0&&e>=w||Y<0&&e<=w)&&(e=w),s.scale.set(e);const n=s.toScreen($.x,$.y);if(s.x+=A.x-n.x,s.y+=A.y-n.y,U(),e===w){y();return}requestAnimationFrame(j)};requestAnimationFrame(j)})}function v(p=!1){return new Promise(y=>{const m=ee/1.5,I=s.x,w=p?I-m:I+m,A=w-I;if(Math.abs(A)<1e-6){y();return}const $=pe/1e3,k=Math.abs(A)/$;let H=performance.now();const X=V=>{if(g){y();return}const j=(V-H)/1e3;H=V;const M=Math.sign(A);let T=s.x+M*k*j;if((M>0&&T>=w||M<0&&T<=w)&&(T=w),s.x=T,U(),T===w){y();return}requestAnimationFrame(X)};requestAnimationFrame(X)})}return ve(()=>{if(!("ontouchstart"in window)&&navigator.maxTouchPoints<1){console.log("Skipping 2D tutorial: no touch support detected");return}u.registerOnReady(ne)}),me(()=>{g=!0,b()}),(p,y)=>{const m=Re;return Q(),le(Se,null,[Z("div",{ref_key:"tutorialContainer",ref:P,class:de(["tutorial",{hide:!B.value}])},[Z("h2",null,ce(p.$t("gallery2d.tutorial")),1),Z("video",{ref_key:"tutorialVideo",ref:R,muted:"",preload:"metadata",onError:O,onCanplay:_,class:de({hide:C.value})},[...y[0]||(y[0]=[Z("source",{src:Me,type:"video/webm"},null,-1)])],34),C.value?(Q(),le("div",Pe,[Z("img",{ref_key:"tutorialImage",ref:F,src:Le,alt:"2D Tutorial"},null,512)])):ue("",!0),xe(m,{class:"tutorial-skip",onClick:W,severity:"contrast",rounded:""},{default:_e(()=>[Te(ce(p.$t("gallery2d.tutorial_skip")),1)]),_:1})],2),(Q(),se(Ae,{to:"body"},[te.value&&!B.value?(Q(),se(m,{key:0,icon:"pi pi-question-circle",onClick:D,raised:"",text:"",rounded:"",severity:"primary",variant:"outlined","aria-label":p.$t("gallery2d.tutorial"),class:"tutorial-button"},null,8,["aria-label"])):ue("",!0)]))],64)}}}),Ne=ge(De,[["__scopeId","data-v-54a22123"]]),Ge={class:"gallery-2d-container"},ke=he({__name:"Gallery2DView",setup(oe){const u={COORDS_URL:"/gallery2d.json",BASE_SPRITE_SIZE:128,BACKGROUND:{COLOR_LIGHT:15132379,COLOR_DARK:1710618},GRID:{COLOR_LIGHT:13290186,COLOR_DARK:3355443,ALPHA_MAJOR:.5,ALPHA_MINOR:.25,MAJOR_LINE_SPACING:100,MINOR_LINE_SPACING:20},INTERACTION:{DRAG_THRESHOLD:5,PINCH_END_DELAY:200},VIEWPORT:{MIN_SCALE:.05,MAX_SCALE:50,FRICTION:.95},SPRITES:{PLACEHOLDER_COLOR:16777215,TEXTURE_SIZES:[128,256,512,1024,1536,2048]},IMAGES:{DEFAULT_SIZE:128,DEFAULT_EXT:"avif",HIGH_RES_SIZE:2048,HIGH_RES_EXT:"jpg"}};function P(e,n=u.IMAGES.DEFAULT_SIZE,t=u.IMAGES.DEFAULT_EXT){return`/gallery/${e}/${e}-${n}.${t}`}function R(e){return new Promise((n,t)=>{if(document.querySelector(`script[src="${e}"]`)){n();return}const a=document.createElement("script");a.src=e,a.async=!0,a.onload=()=>n(),a.onerror=()=>t(new Error(`Failed to load script: ${e}`)),document.head.appendChild(a)})}async function F(){await R("https://cdn.jsdelivr.net/npm/pixi.js@7.4.3/dist/pixi.min.js"),await R("https://cdn.jsdelivr.net/npm/pixi-viewport@5.1.0/dist/viewport.min.js")}const{setTitle:C,setIcon:s,resetAppBar:K}=Ce(),{enableSearch:ee,setSearchResultsCallback:U,disableSearch:G}=Oe(),{showError:q,showLoading:te,closePopup:B}=be(),g=N(null),f=fe(null),l=fe(null),ne=N([]),O=new Map,_=new Map;let D=0,W=0,b=null,E=null,v=null;async function p(){try{te("gallery2d.loading"),await F(),await I(),await w(),A(),$(),k(),f.value.ticker.add(V),B()}catch(e){console.error("Failed to initialize gallery:",e),q("gallery2d.error",e.message,!0)}}async function y(){if(window.PIXI&&window.PIXI.Assets){const e=Array.from(O.keys()).map(n=>{const[t,a]=n.split("-");return P(t,a)});e.length>0&&await window.PIXI.Assets.unload(e)}O.clear(),_.clear(),f.value&&f.value.destroy(!0,{children:!0,texture:!1,baseTexture:!1}),b&&(b.disconnect(),b=null),window.removeEventListener("resize",M)}async function m(e){if(e.length===0){_.forEach(i=>{i.alpha=1});return}const n=new Map;e.forEach(i=>{n.set(i.imageName,i.similarity)});const t=Math.min(...n.values()),a=Math.max(...n.values());_.forEach((i,h)=>{i.alpha=(n.get(h)??0-t)/(a-t)})}async function I(){const n=document.documentElement.classList.contains("dark")?u.BACKGROUND.COLOR_DARK:u.BACKGROUND.COLOR_LIGHT;f.value=new window.PIXI.Application({width:window.innerWidth,height:window.innerHeight,backgroundColor:n,autoDensity:!1,antialias:!0,powerPreference:"high-performance"}),g.value&&(g.value.appendChild(f.value.view),f.value.view.style.touchAction="none"),f.value.renderer.events.moveOnAll=!0,b=new MutationObserver(()=>{if(f.value&&f.value.renderer){const t=document.documentElement.classList.contains("dark");f.value.renderer.background.color=t?u.BACKGROUND.COLOR_DARK:u.BACKGROUND.COLOR_LIGHT,v&&v()}}),b.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),window.addEventListener("resize",M)}async function w(){const n=await(await fetch(u.COORDS_URL)).json(),t=Object.entries(n).map(([c,d])=>({name:c,x:d[0],y:d[1]})),a=Math.min(...t.map(c=>c.x)),i=Math.max(...t.map(c=>c.x)),h=Math.min(...t.map(c=>c.y)),x=Math.max(...t.map(c=>c.y));D=i-a,W=x-h,ne.value=t.map(c=>({...c,x:c.x-a,y:c.y-h}))}function A(){l.value=new window.PIXI.Viewport({screenWidth:window.innerWidth,screenHeight:window.innerHeight,worldWidth:D,worldHeight:W,events:f.value.renderer.events}),f.value.stage.addChild(l.value);let e=!1,n=null,t=null,a=null;const i=new Map;let h=0,x=null,c=!1,d=!1;l.value.eventMode="static",l.value.hitArea=f.value.screen,l.value.on("pointerdown",r=>{if(r.pointerType==="touch")if(i.set(r.pointerId,{x:r.global.x,y:r.global.y}),i.size===2){c=!0,e=!1,a=null,l.value.plugins.pause("decelerate");const o=Array.from(i.values());h=Math.hypot(o[0].x-o[1].x,o[0].y-o[1].y),x={x:(o[0].x+o[1].x)/2,y:(o[0].y+o[1].y)/2}}else i.size===1&&!c&&(t={x:r.global.x,y:r.global.y},n={x:r.global.x,y:r.global.y},e=!1,a={x:r.global.x,y:r.global.y});else r.originalEvent.button===0&&(t={x:r.global.x,y:r.global.y},n={x:r.global.x,y:r.global.y},e=!1,a={x:r.global.x,y:r.global.y},l.value.plugins.pause("decelerate"))}),l.value.on("pointermove",r=>{if(r.pointerType==="touch"){if(!i.has(r.pointerId))return;if(i.set(r.pointerId,{x:r.global.x,y:r.global.y}),i.size===2&&c){const o=Array.from(i.values()),z=Math.hypot(o[0].x-o[1].x,o[0].y-o[1].y),L={x:(o[0].x+o[1].x)/2,y:(o[0].y+o[1].y)/2};if(h>0&&z>0&&x){const ae=L.x-x.x,S=L.y-x.y;l.value.x+=ae,l.value.y+=S;const we=z/h,ie=l.value.toWorld(L),Ie=l.value.scale.x,Ee=Math.max(u.VIEWPORT.MIN_SCALE,Math.min(u.VIEWPORT.MAX_SCALE,Ie*we));l.value.scale.set(Ee);const re=l.value.toScreen(ie.x,ie.y);l.value.x+=L.x-re.x,l.value.y+=L.y-re.y,v&&v()}h=z,x=L}else i.size===1&&!c&&!d&&(!e&&t&&Math.hypot(r.global.x-t.x,r.global.y-t.y)>u.INTERACTION.DRAG_THRESHOLD&&(e=!0,a=null),e&&n&&(l.value.x+=r.global.x-n.x,l.value.y+=r.global.y-n.y,v&&v()),n={x:r.global.x,y:r.global.y})}else if(n&&t){const o={x:r.global.x,y:r.global.y};e||Math.hypot(o.x-t.x,o.y-t.y)>u.INTERACTION.DRAG_THRESHOLD&&(e=!0,a=null),e&&(l.value.x+=o.x-n.x,l.value.y+=o.y-n.y,v&&v()),n=o}});const J=r=>{if(r.pointerType==="touch"){if(!e&&!c&&!d&&a&&i.size===1){const o=X(a.x,a.y);o&&H(o)}if(i.delete(r.pointerId),i.size<2&&c&&(c=!1,h=0,x=null,d=!0,setTimeout(()=>{d=!1},u.INTERACTION.PINCH_END_DELAY),i.size===1)){const o=i.values().next().value;o&&(t={x:o.x,y:o.y},n={x:o.x,y:o.y},e=!1,a={x:o.x,y:o.y})}i.size<1&&(e&&l.value.plugins.resume("decelerate"),e=!1,n=null,t=null,a=null,d=!1)}else if(r.originalEvent.button===0){if(!e&&a){const o=X(a.x,a.y);o&&H(o)}e&&l.value.plugins.resume("decelerate"),e=!1,n=null,t=null,a=null}};l.value.on("pointerup",J),l.value.on("pointerupoutside",J),l.value.on("pointercancel",J),l.value.wheel().decelerate({friction:u.VIEWPORT.FRICTION}),l.value.clampZoom({minScale:u.VIEWPORT.MIN_SCALE,maxScale:u.VIEWPORT.MAX_SCALE}),l.value.fit(),l.value.moveCenter(D/2,W/2)}function $(){E=new window.PIXI.Graphics,l.value.addChild(E),v=()=>{E.clear();const e=l.value.getVisibleBounds(),n=u.GRID.MAJOR_LINE_SPACING,t=u.GRID.MINOR_LINE_SPACING,a=Math.min(1,l.value.scale.x*2),i=Math.min(1,l.value.scale.x*4),x=document.documentElement.classList.contains("dark")?u.GRID.COLOR_DARK:u.GRID.COLOR_LIGHT,c=(d,J,r)=>{E.lineStyle(r/l.value.scale.x,x,J);const o=Math.floor(e.x/d)*d,z=Math.ceil((e.x+e.width)/d)*d,L=Math.floor(e.y/d)*d,ae=Math.ceil((e.y+e.height)/d)*d;for(let S=o;S<z;S+=d)E.moveTo(S,L),E.lineTo(S,ae);for(let S=L;S<ae;S+=d)E.moveTo(o,S),E.lineTo(z,S)};i>.1&&c(t,i,u.GRID.ALPHA_MINOR),a>.05&&c(n,a,u.GRID.ALPHA_MAJOR)},l.value.on("moved",v),v()}function k(){const e=new window.PIXI.Graphics().beginFill(u.SPRITES.PLACEHOLDER_COLOR).drawRect(0,0,128,128).endFill(),n=f.value.renderer.generateTexture(e);ne.value.forEach(t=>{const a=new window.PIXI.Sprite(n);a.anchor.set(.5),a.width=u.BASE_SPRITE_SIZE,a.height=u.BASE_SPRITE_SIZE,a.x=t.x,a.y=t.y,a.eventMode="none",a.name=t.name,l.value.addChild(a),_.set(t.name,a)})}function H(e){if(e&&e.name){const n=P(e.name,u.IMAGES.HIGH_RES_SIZE,u.IMAGES.HIGH_RES_EXT);window.open(n,"_blank")}else console.warn("Click handler called with invalid sprite:",e)}function X(e,n){for(const t of _.values())if(t.getBounds().contains(e,n))return t;return null}function V(){if(!l.value)return;const e=l.value.getVisibleBounds(),n=l.value.scale.x;_.forEach((t,a)=>{const i=t.x>e.x-t.width/2&&t.x<e.x+e.width+t.width/2&&t.y>e.y-t.height/2&&t.y<e.y+e.height+t.height/2;if(t.visible=i,i){const h=u.BASE_SPRITE_SIZE*n,x=u.SPRITES.TEXTURE_SIZES,c=x.find(d=>d>=h)||x[x.length-1];j(a,c)}})}async function j(e,n){const t=`${e}-${n}`;if(O.has(t)){const i=_.get(e);i&&i.texture!==O.get(t)&&(i.texture=O.get(t));return}const a=P(e,n);try{const i=await window.PIXI.Assets.load(a);O.set(t,i);const h=_.get(e);h&&(h.texture=i)}catch(i){console.warn(`Could not load texture: ${a}`,i),O.set(t,null)}}function M(){!f.value||!l.value||(f.value.renderer.resize(window.innerWidth,window.innerHeight),l.value.resize(window.innerWidth,window.innerHeight,D,W))}let T=null;function Y(e){T=e}return ve(async()=>{C("gallery2d.title"),s("pi pi-hashtag"),await p(),ee(),U(m),T?.(l.value,u,D,v)}),me(()=>{K(),G(),y()}),(e,n)=>(Q(),le("div",Ge,[xe(Ne,{registerOnReady:Y}),Z("div",{ref_key:"canvasContainer",ref:g,class:"gallery-canvas"},null,512)]))}}),Xe=ge(ke,[["__scopeId","data-v-670ca438"]]);export{Xe as default};
