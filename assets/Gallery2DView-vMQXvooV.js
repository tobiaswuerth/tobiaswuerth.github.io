import{d as he,r as G,o as ve,a as me,b as le,e as Q,F as Se,f as K,l as se,m as ue,i as xe,t as ce,p as de,q as Re,w as _e,T as Ae,v as Te,_ as ge,g as Ce,u as Oe,h as be,x as fe}from"./main-Ry670m9D.js";const Me="/2d-tutorial.webm",Pe="/2d-tutorial-alt.png",Le={key:0},pe=1500,ye="gallery2d.tutorial_viewed",De=he({__name:"Gallery2DTutorial",props:{registerOnReady:{type:Function}},setup(oe){const u=oe,D=G(null),R=G(null),U=G(null),O=G(!0);let s=null,q=null,ee=null,B=null,k=null,Y=null;const te=G(!1),W=G(!1);let g=!1;function d(){try{return!!localStorage.getItem(ye)}catch{return!1}}function o(){try{localStorage.setItem(ye,"1")}catch{}}function ne(f,p,v,I){if(!f||!p||!v||!I){console.warn("Tutorial not starting: missing required parameters"),console.debug({viewport_:f,config_:p,worldWidth_:v,drawGrid_:I});return}console.log("2D tutorial ready"),s=f,q=p,ee=v,B=I,te.value=!0,d()||N()}function b(){console.warn("Tutorial video: error loading/playing source"),O.value=!0}function _(){O.value=!1}async function N(){if(!D.value||!R.value){console.warn("Tutorial not starting: tutorial container or tutorial video not initialized"),console.debug({tutorialContainer:D.value,tutorialVideo:R.value});return}if(g=!1,W.value=!0,k={x:s.x,y:s.y,scale:s.scale.x},Y=s.eventMode,s.eventMode="none",s.plugins.pause("decelerate"),s.plugins.pause("drag"),s.plugins.pause("pinch"),s.plugins.pause("wheel"),!O.value)try{R.value.currentTime=0,await R.value.play()}catch(f){console.warn("Tutorial video cannot be played:",f),O.value=!0}O.value&&U.value&&(U.value.src="",U.value.src="/2d-tutorial-alt.png"),await E(!1),!g&&(await h(!1),!g&&(await h(!0),!g&&(await E(!0),!g&&(o(),M()))))}function $(){g=!0,M(),o()}function M(){if(!D.value||!R.value){console.error("Tutorial not stopping: tutorial container or tutorial video not initialized");return}if(W.value=!1,R.value.pause(),k&&s)try{s.x=k.x,s.y=k.y,s.scale.set(k.scale)}catch{}Y!==null&&s?s.eventMode=Y:s.eventMode="static",s.plugins.resume("decelerate"),s.plugins.resume("drag"),s.plugins.resume("pinch"),s.plugins.resume("wheel"),B()}function E(f=!1){return new Promise(p=>{const v=s.scale.x,I=f?v/10:v*10,w=f?Math.max(q.VIEWPORT.MIN_SCALE,I):Math.min(q.VIEWPORT.MAX_SCALE,I),A={x:window.innerWidth/2,y:window.innerHeight/2},j=s.toWorld(A.x,A.y),H=w-v;if(Math.abs(H)<1e-6){p();return}const X=pe/1e3,V=Math.abs(H)/X;let z=performance.now();const Z=P=>{if(g){p();return}const T=(P-z)/1e3;z=P;const J=Math.sign(H);let e=s.scale.x+J*V*T;(J>0&&e>=w||J<0&&e<=w)&&(e=w),s.scale.set(e);const a=s.toScreen(j.x,j.y);if(s.x+=A.x-a.x,s.y+=A.y-a.y,B(),e===w){p();return}requestAnimationFrame(Z)};requestAnimationFrame(Z)})}function h(f=!1){return new Promise(p=>{const v=ee/1.5,I=s.x,w=f?I-v:I+v,A=w-I;if(Math.abs(A)<1e-6){p();return}const j=pe/1e3,H=Math.abs(A)/j;let X=performance.now();const V=z=>{if(g){p();return}const Z=(z-X)/1e3;X=z;const P=Math.sign(A);let T=s.x+P*H*Z;if((P>0&&T>=w||P<0&&T<=w)&&(T=w),s.x=T,B(),T===w){p();return}requestAnimationFrame(V)};requestAnimationFrame(V)})}return ve(()=>{if(!("ontouchstart"in window)&&navigator.maxTouchPoints<1){console.log("Skipping 2D tutorial: no touch support detected");return}u.registerOnReady(ne)}),me(()=>{g=!0,M()}),(f,p)=>{const v=Re;return Q(),le(Se,null,[K("div",{ref_key:"tutorialContainer",ref:D,class:de(["tutorial",{hide:!W.value}])},[K("h2",null,ce(f.$t("gallery2d.tutorial")),1),K("video",{ref_key:"tutorialVideo",ref:R,muted:"",preload:"metadata",onError:b,onCanplay:_,class:de({hide:O.value})},[...p[0]||(p[0]=[K("source",{src:Me,type:"video/webm"},null,-1)])],34),O.value?(Q(),le("div",Le,[K("img",{ref_key:"tutorialImage",ref:U,src:Pe,alt:"2D Tutorial"},null,512)])):ue("",!0),xe(v,{class:"tutorial-skip",onClick:$,severity:"contrast",rounded:""},{default:_e(()=>[Te(ce(f.$t("gallery2d.tutorial_skip")),1)]),_:1})],2),(Q(),se(Ae,{to:"body"},[te.value&&!W.value?(Q(),se(v,{key:0,icon:"pi pi-question-circle",onClick:N,raised:"",text:"",rounded:"",severity:"primary",variant:"outlined","aria-label":f.$t("gallery2d.tutorial"),class:"tutorial-button"},null,8,["aria-label"])):ue("",!0)]))],64)}}}),Ne=ge(De,[["__scopeId","data-v-54a22123"]]),Ge={class:"gallery-2d-container"},ke=he({__name:"Gallery2DView",setup(oe){const u={COORDS_URL:"/gallery2d.json",BASE_SPRITE_SIZE:25,BACKGROUND:{COLOR_LIGHT:15132379,COLOR_DARK:1710618},GRID:{COLOR_LIGHT:13290186,COLOR_DARK:3355443,ALPHA_MAJOR:.5,ALPHA_MINOR:.25,MAJOR_LINE_SPACING:100,MINOR_LINE_SPACING:20},INTERACTION:{DRAG_THRESHOLD:5,PINCH_END_DELAY:200},VIEWPORT:{MIN_SCALE:.2,MAX_SCALE:75,FRICTION:.95},SPRITES:{PLACEHOLDER_COLOR:16777215,TEXTURE_SIZES:[128,256,512,1024,1536,2048]},IMAGES:{DEFAULT_SIZE:128,DEFAULT_EXT:"avif",HIGH_RES_SIZE:2048,HIGH_RES_EXT:"jpg"}};function D(e,a=u.IMAGES.DEFAULT_SIZE,t=u.IMAGES.DEFAULT_EXT){return`/gallery/${e}/${e}-${a}.${t}`}function R(e){return new Promise((a,t)=>{if(document.querySelector(`script[src="${e}"]`)){a();return}const l=document.createElement("script");l.src=e,l.async=!0,l.onload=()=>a(),l.onerror=()=>t(new Error(`Failed to load script: ${e}`)),document.head.appendChild(l)})}async function U(){await R("https://cdn.jsdelivr.net/npm/pixi.js@7.4.3/dist/pixi.min.js"),await R("https://cdn.jsdelivr.net/npm/pixi-viewport@5.1.0/dist/viewport.min.js")}const{setTitle:O,setIcon:s,resetAppBar:q}=Ce(),{enableSearch:ee,setSearchResultsCallback:B,disableSearch:k}=Oe(),{showError:Y,showLoading:te,closePopup:W}=be(),g=G(null),d=fe(null),o=fe(null),ne=G([]),b=new Map,_=new Map;let N=0,$=0,M=null,E=null,h=null;async function f(){try{te("gallery2d.loading"),await U(),await I(),await w(),A(),j(),H(),d.value.ticker.add(z),W()}catch(e){console.error("Failed to initialize gallery:",e),Y("gallery2d.error",e.message,!0)}}async function p(){if(window.PIXI&&window.PIXI.Assets){const e=Array.from(b.keys()).map(a=>{const[t,l]=a.split("-");return D(t,l)});e.length>0&&await window.PIXI.Assets.unload(e)}b.clear(),_.clear(),d.value&&d.value.destroy(!0,{children:!0,texture:!1,baseTexture:!1}),M&&(M.disconnect(),M=null),window.removeEventListener("resize",P)}async function v(e){if(e.length===0){_.forEach(r=>{r.alpha=1});return}const a=new Map;e.forEach(r=>{a.set(r.imageName,r.similarity)});const t=Math.min(...a.values()),l=Math.max(...a.values());_.forEach((r,y)=>{r.alpha=(a.get(y)??0-t)/(l-t)})}async function I(){const a=document.documentElement.classList.contains("dark")?u.BACKGROUND.COLOR_DARK:u.BACKGROUND.COLOR_LIGHT;d.value=new window.PIXI.Application({width:window.innerWidth,height:window.innerHeight,backgroundColor:a,resolution:Math.max(1,Math.min(window.devicePixelRatio||1,2)),autoDensity:!0,antialias:!0,powerPreference:"high-performance",hello:!1}),g.value&&(g.value.appendChild(d.value.view),d.value.view.style.touchAction="none"),d.value.renderer.events.moveOnAll=!0,M=new MutationObserver(()=>{if(d.value&&d.value.renderer){const t=document.documentElement.classList.contains("dark");d.value.renderer.background.color=t?u.BACKGROUND.COLOR_DARK:u.BACKGROUND.COLOR_LIGHT,h&&h()}}),M.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),window.addEventListener("resize",P)}async function w(){const a=await(await fetch(u.COORDS_URL)).json(),t=Object.entries(a).map(([n,i])=>({name:n,x:i[0],y:i[1]})),l=Math.min(...t.map(n=>n.x)),r=Math.max(...t.map(n=>n.x)),y=Math.min(...t.map(n=>n.y)),x=Math.max(...t.map(n=>n.y)),m=r-l,c=x-y,C=Math.min(window.innerWidth/m,window.innerHeight/c)*2;N=m*C,$=c*C,ne.value=t.map(n=>({...n,x:(n.x-l)*C,y:(n.y-y)*C}))}function A(){o.value=new window.PIXI.Viewport({screenWidth:window.innerWidth,screenHeight:window.innerHeight,worldWidth:N,worldHeight:$,events:d.value.renderer.events}),d.value.stage.addChild(o.value);let e=!1,a=null,t=null,l=null;const r=new Map;let y=0,x=null,m=!1,c=!1;o.value.eventMode="static",o.value.hitArea=d.value.screen,o.value.on("pointerdown",n=>{if(n.pointerType==="touch")if(r.set(n.pointerId,{x:n.global.x,y:n.global.y}),r.size===2){m=!0,e=!1,l=null,o.value.plugins.pause("decelerate");const i=Array.from(r.values());y=Math.hypot(i[0].x-i[1].x,i[0].y-i[1].y),x={x:(i[0].x+i[1].x)/2,y:(i[0].y+i[1].y)/2}}else r.size===1&&!m&&(t={x:n.global.x,y:n.global.y},a={x:n.global.x,y:n.global.y},e=!1,l={x:n.global.x,y:n.global.y});else n.originalEvent.button===0&&(t={x:n.global.x,y:n.global.y},a={x:n.global.x,y:n.global.y},e=!1,l={x:n.global.x,y:n.global.y},o.value.plugins.pause("decelerate"))}),o.value.on("pointermove",n=>{if(n.pointerType==="touch"){if(!r.has(n.pointerId))return;if(r.set(n.pointerId,{x:n.global.x,y:n.global.y}),r.size===2&&m){const i=Array.from(r.values()),F=Math.hypot(i[0].x-i[1].x,i[0].y-i[1].y),L={x:(i[0].x+i[1].x)/2,y:(i[0].y+i[1].y)/2};if(y>0&&F>0&&x){const ae=L.x-x.x,S=L.y-x.y;o.value.x+=ae,o.value.y+=S;const we=F/y,ie=o.value.toWorld(L),Ie=o.value.scale.x,Ee=Math.max(u.VIEWPORT.MIN_SCALE,Math.min(u.VIEWPORT.MAX_SCALE,Ie*we));o.value.scale.set(Ee);const re=o.value.toScreen(ie.x,ie.y);o.value.x+=L.x-re.x,o.value.y+=L.y-re.y,h&&h()}y=F,x=L}else r.size===1&&!m&&!c&&(!e&&t&&Math.hypot(n.global.x-t.x,n.global.y-t.y)>u.INTERACTION.DRAG_THRESHOLD&&(e=!0,l=null),e&&a&&(o.value.x+=n.global.x-a.x,o.value.y+=n.global.y-a.y,h&&h()),a={x:n.global.x,y:n.global.y})}else if(a&&t){const i={x:n.global.x,y:n.global.y};e||Math.hypot(i.x-t.x,i.y-t.y)>u.INTERACTION.DRAG_THRESHOLD&&(e=!0,l=null),e&&(o.value.x+=i.x-a.x,o.value.y+=i.y-a.y,h&&h()),a=i}});const C=n=>{if(n.pointerType==="touch"){if(!e&&!m&&!c&&l&&r.size===1){const i=V(l.x,l.y);i&&X(i)}if(r.delete(n.pointerId),r.size<2&&m&&(m=!1,y=0,x=null,c=!0,setTimeout(()=>{c=!1},u.INTERACTION.PINCH_END_DELAY),r.size===1)){const i=r.values().next().value;i&&(t={x:i.x,y:i.y},a={x:i.x,y:i.y},e=!1,l={x:i.x,y:i.y})}r.size<1&&(e&&o.value.plugins.resume("decelerate"),e=!1,a=null,t=null,l=null,c=!1)}else if(n.originalEvent.button===0){if(!e&&l){const i=V(l.x,l.y);i&&X(i)}e&&o.value.plugins.resume("decelerate"),e=!1,a=null,t=null,l=null}};o.value.on("pointerup",C),o.value.on("pointerupoutside",C),o.value.on("pointercancel",C),o.value.wheel().decelerate({friction:u.VIEWPORT.FRICTION}),o.value.clampZoom({minScale:u.VIEWPORT.MIN_SCALE,maxScale:u.VIEWPORT.MAX_SCALE}),o.value.fit(),o.value.moveCenter(N/2,$/2)}function j(){E=new window.PIXI.Graphics,o.value.addChild(E),h=()=>{E.clear();const e=o.value.getVisibleBounds(),a=u.GRID.MAJOR_LINE_SPACING,t=u.GRID.MINOR_LINE_SPACING,l=Math.min(1,o.value.scale.x*2),r=Math.min(1,o.value.scale.x*4),x=document.documentElement.classList.contains("dark")?u.GRID.COLOR_DARK:u.GRID.COLOR_LIGHT,m=(c,C,n)=>{E.lineStyle(n/o.value.scale.x,x,C);const i=Math.floor(e.x/c)*c,F=Math.ceil((e.x+e.width)/c)*c,L=Math.floor(e.y/c)*c,ae=Math.ceil((e.y+e.height)/c)*c;for(let S=i;S<F;S+=c)E.moveTo(S,L),E.lineTo(S,ae);for(let S=L;S<ae;S+=c)E.moveTo(i,S),E.lineTo(F,S)};r>.1&&m(t,r,u.GRID.ALPHA_MINOR),l>.05&&m(a,l,u.GRID.ALPHA_MAJOR)},o.value.on("moved",h),h()}function H(){const e=new window.PIXI.Graphics().beginFill(u.SPRITES.PLACEHOLDER_COLOR).drawRect(0,0,128,128).endFill(),a=d.value.renderer.generateTexture(e);ne.value.forEach(t=>{const l=new window.PIXI.Sprite(a);l.anchor.set(.5),l.width=u.BASE_SPRITE_SIZE,l.height=u.BASE_SPRITE_SIZE,l.x=t.x,l.y=t.y,l.eventMode="none",l.name=t.name,o.value.addChild(l),_.set(t.name,l)})}function X(e){if(e&&e.name){const a=D(e.name,u.IMAGES.HIGH_RES_SIZE,u.IMAGES.HIGH_RES_EXT);window.open(a,"_blank")}else console.warn("Click handler called with invalid sprite:",e)}function V(e,a){for(const t of _.values())if(t.getBounds().contains(e,a))return t;return null}function z(){if(!o.value)return;const e=o.value.getVisibleBounds(),a=o.value.scale.x;_.forEach((t,l)=>{const r=t.x>e.x-t.width/2&&t.x<e.x+e.width+t.width/2&&t.y>e.y-t.height/2&&t.y<e.y+e.height+t.height/2;if(t.visible=r,r){const y=u.BASE_SPRITE_SIZE*a,x=u.SPRITES.TEXTURE_SIZES,m=x.find(c=>c>=y)||x[x.length-1];Z(l,m)}})}async function Z(e,a){const t=`${e}-${a}`;if(b.has(t)){const r=_.get(e);r&&r.texture!==b.get(t)&&(r.texture=b.get(t));return}const l=D(e,a);try{const r=await window.PIXI.Assets.load(l);b.set(t,r);const y=_.get(e);y&&(y.texture=r)}catch(r){console.warn(`Could not load texture: ${l}`,r),b.set(t,null)}}function P(){!d.value||!o.value||(d.value.renderer.resize(window.innerWidth,window.innerHeight),o.value.resize(window.innerWidth,window.innerHeight,N,$))}let T=null;function J(e){T=e}return ve(async()=>{O("gallery2d.title"),s("pi pi-hashtag"),await f(),ee(),B(v),T?.(o.value,u,N,h)}),me(()=>{q(),k(),p()}),(e,a)=>(Q(),le("div",Ge,[xe(Ne,{registerOnReady:J}),K("div",{ref_key:"canvasContainer",ref:g,class:"gallery-canvas"},null,512)]))}}),Xe=ge(ke,[["__scopeId","data-v-bea9cf31"]]);export{Xe as default};
