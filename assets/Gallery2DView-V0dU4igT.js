import{d as re,u as ce,a as ue,r as S,l as B,o as de,b as he,c as U,e as L,g as V,h as ve,i as D,f as ye,m as z,t as W,j as fe,k as xe,_ as Ie}from"./main-Cmiqh7u7.js";import{s as pe,a as we}from"./index-C2N8Gs4q.js";const Ee={class:"gallery-2d-container"},me={key:0,class:"loading-overlay"},ge={class:"loading-content"},_e=re({__name:"Gallery2DView",setup(Re){const r={COORDS_URL:"/gallery2d.json",BASE_SPRITE_SIZE:25,BACKGROUND:{COLOR_LIGHT:15132379,COLOR_DARK:1710618},GRID:{COLOR_LIGHT:13290186,COLOR_DARK:3355443,ALPHA_MAJOR:.5,ALPHA_MINOR:.25,MAJOR_LINE_SPACING:100,MINOR_LINE_SPACING:20},INTERACTION:{DRAG_THRESHOLD:5,PINCH_END_DELAY:200},VIEWPORT:{MIN_SCALE:.2,MAX_SCALE:75,FRICTION:.95},SPRITES:{PLACEHOLDER_COLOR:16777215,TEXTURE_SIZES:[128,256,512,1024,1536,2048]},IMAGES:{DEFAULT_SIZE:128,DEFAULT_EXT:"avif",HIGH_RES_SIZE:2048,HIGH_RES_EXT:"jpg"}};function b(e,i=r.IMAGES.DEFAULT_SIZE,n=r.IMAGES.DEFAULT_EXT){return`/gallery/${e}/${e}-${i}.${n}`}function P(e){return new Promise((i,n)=>{if(document.querySelector(`script[src="${e}"]`)){i();return}const l=document.createElement("script");l.src=e,l.async=!0,l.onload=()=>i(),l.onerror=()=>n(new Error(`Failed to load script: ${e}`)),document.head.appendChild(l)})}async function j(){await P("https://cdn.jsdelivr.net/npm/pixi.js@7.4.3/dist/pixi.min.js"),await P("https://cdn.jsdelivr.net/npm/pixi-viewport@5.1.0/dist/viewport.min.js")}const{t:F}=ce(),{setTitle:Z,setIcon:$,reset:K}=ue(),T=S(null),O=S(!0),C=S(""),u=B(null),o=B(null),M=S([]),E=new Map,m=new Map;let _=0,R=0,g=null,p=null,y=null;async function Y(){try{O.value=!0,await j(),await q(),await Q(),ee(),te(),ne(),u.value.ticker.add(ae)}catch(e){console.error("Failed to initialize gallery:",e),C.value=F("gallery2d.error",{error:e.message})}finally{O.value=!1}}function J(){u.value&&u.value.destroy(!0,{children:!0,texture:!0,baseTexture:!0}),g&&(g.disconnect(),g=null),window.removeEventListener("resize",H)}async function q(){const i=document.documentElement.classList.contains("dark")?r.BACKGROUND.COLOR_DARK:r.BACKGROUND.COLOR_LIGHT;u.value=new window.PIXI.Application({width:window.innerWidth,height:window.innerHeight,backgroundColor:i,resolution:Math.max(1,Math.min(window.devicePixelRatio||1,2)),autoDensity:!0,antialias:!0,powerPreference:"high-performance",hello:!1}),T.value&&(T.value.appendChild(u.value.view),u.value.view.style.touchAction="none"),u.value.renderer.events.moveOnAll=!0,g=new MutationObserver(()=>{if(u.value&&u.value.renderer){const n=document.documentElement.classList.contains("dark");u.value.renderer.background.color=n?r.BACKGROUND.COLOR_DARK:r.BACKGROUND.COLOR_LIGHT,y&&y()}}),g.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),window.addEventListener("resize",H)}async function Q(){const i=await(await fetch(r.COORDS_URL)).json(),n=Object.entries(i).map(([t,a])=>({name:t,x:a[0],y:a[1]})),l=Math.min(...n.map(t=>t.x)),s=Math.max(...n.map(t=>t.x)),h=Math.min(...n.map(t=>t.y)),v=Math.max(...n.map(t=>t.y)),d=s-l,c=v-h,x=Math.min(window.innerWidth/d,window.innerHeight/c)*2;_=d*x,R=c*x,M.value=n.map(t=>({...t,x:(t.x-l)*x,y:(t.y-h)*x}))}function ee(){o.value=new window.PIXI.Viewport({screenWidth:window.innerWidth,screenHeight:window.innerHeight,worldWidth:_,worldHeight:R,events:u.value.renderer.events}),u.value.stage.addChild(o.value);let e=!1,i=null,n=null,l=null;const s=new Map;let h=0,v=null,d=!1,c=!1;o.value.eventMode="static",o.value.hitArea=u.value.screen,o.value.on("pointerdown",t=>{if(t.pointerType==="touch")if(s.set(t.pointerId,{x:t.global.x,y:t.global.y}),s.size===2){d=!0,e=!1,l=null,o.value.plugins.pause("decelerate");const a=Array.from(s.values());h=Math.hypot(a[0].x-a[1].x,a[0].y-a[1].y),v={x:(a[0].x+a[1].x)/2,y:(a[0].y+a[1].y)/2}}else s.size===1&&!d&&(n={x:t.global.x,y:t.global.y},i={x:t.global.x,y:t.global.y},e=!1,l={x:t.global.x,y:t.global.y});else t.originalEvent.button===0&&(n={x:t.global.x,y:t.global.y},i={x:t.global.x,y:t.global.y},e=!1,l={x:t.global.x,y:t.global.y},o.value.plugins.pause("decelerate"))}),o.value.on("pointermove",t=>{if(t.pointerType==="touch"){if(!s.has(t.pointerId))return;if(s.set(t.pointerId,{x:t.global.x,y:t.global.y}),s.size===2&&d){const a=Array.from(s.values()),w=Math.hypot(a[0].x-a[1].x,a[0].y-a[1].y),I={x:(a[0].x+a[1].x)/2,y:(a[0].y+a[1].y)/2};if(h>0&&w>0&&v){const A=I.x-v.x,f=I.y-v.y;o.value.x+=A,o.value.y+=f;const oe=w/h,k=o.value.toWorld(I),ie=o.value.scale.x,se=Math.max(r.VIEWPORT.MIN_SCALE,Math.min(r.VIEWPORT.MAX_SCALE,ie*oe));o.value.scale.set(se);const X=o.value.toScreen(k.x,k.y);o.value.x+=I.x-X.x,o.value.y+=I.y-X.y,y&&y()}h=w,v=I}else s.size===1&&!d&&!c&&(!e&&n&&Math.hypot(t.global.x-n.x,t.global.y-n.y)>r.INTERACTION.DRAG_THRESHOLD&&(e=!0,l=null),e&&i&&(o.value.x+=t.global.x-i.x,o.value.y+=t.global.y-i.y,y&&y()),i={x:t.global.x,y:t.global.y})}else if(i&&n){const a={x:t.global.x,y:t.global.y};e||Math.hypot(a.x-n.x,a.y-n.y)>r.INTERACTION.DRAG_THRESHOLD&&(e=!0,l=null),e&&(o.value.x+=a.x-i.x,o.value.y+=a.y-i.y,y&&y()),i=a}});const x=t=>{if(t.pointerType==="touch"){if(!e&&!d&&!c&&l&&s.size===1){const a=N(l.x,l.y);a&&G(a)}if(s.delete(t.pointerId),s.size<2&&d&&(d=!1,h=0,v=null,c=!0,setTimeout(()=>{c=!1},r.INTERACTION.PINCH_END_DELAY),s.size===1)){const a=s.values().next().value;a&&(n={x:a.x,y:a.y},i={x:a.x,y:a.y},e=!1,l={x:a.x,y:a.y})}s.size<1&&(e&&o.value.plugins.resume("decelerate"),e=!1,i=null,n=null,l=null,c=!1)}else if(t.originalEvent.button===0){if(!e&&l){const a=N(l.x,l.y);a&&G(a)}e&&o.value.plugins.resume("decelerate"),e=!1,i=null,n=null,l=null}};o.value.on("pointerup",x),o.value.on("pointerupoutside",x),o.value.on("pointercancel",x),o.value.wheel().decelerate({friction:r.VIEWPORT.FRICTION}),o.value.clampZoom({minScale:r.VIEWPORT.MIN_SCALE,maxScale:r.VIEWPORT.MAX_SCALE}),o.value.fit(),o.value.moveCenter(_/2,R/2)}function te(){p=new window.PIXI.Graphics,o.value.addChild(p),y=()=>{p.clear();const e=o.value.getVisibleBounds(),i=r.GRID.MAJOR_LINE_SPACING,n=r.GRID.MINOR_LINE_SPACING,l=Math.min(1,o.value.scale.x*2),s=Math.min(1,o.value.scale.x*4),v=document.documentElement.classList.contains("dark")?r.GRID.COLOR_DARK:r.GRID.COLOR_LIGHT,d=(c,x,t)=>{p.lineStyle(t/o.value.scale.x,v,x);const a=Math.floor(e.x/c)*c,w=Math.ceil((e.x+e.width)/c)*c,I=Math.floor(e.y/c)*c,A=Math.ceil((e.y+e.height)/c)*c;for(let f=a;f<w;f+=c)p.moveTo(f,I),p.lineTo(f,A);for(let f=I;f<A;f+=c)p.moveTo(a,f),p.lineTo(w,f)};s>.1&&d(n,s,r.GRID.ALPHA_MINOR),l>.05&&d(i,l,r.GRID.ALPHA_MAJOR)},o.value.on("moved",y),y()}function ne(){const e=new window.PIXI.Graphics().beginFill(r.SPRITES.PLACEHOLDER_COLOR).drawRect(0,0,128,128).endFill(),i=u.value.renderer.generateTexture(e);M.value.forEach(n=>{const l=new window.PIXI.Sprite(i);l.anchor.set(.5),l.width=r.BASE_SPRITE_SIZE,l.height=r.BASE_SPRITE_SIZE,l.x=n.x,l.y=n.y,l.eventMode="none",l.name=n.name,o.value.addChild(l),m.set(n.name,l)})}function G(e){if(e&&e.name){const i=b(e.name,r.IMAGES.HIGH_RES_SIZE,r.IMAGES.HIGH_RES_EXT);window.open(i,"_blank")}else console.warn("Click handler called with invalid sprite:",e)}function N(e,i){for(const n of m.values())if(n.getBounds().contains(e,i))return n;return null}function ae(){if(!o.value)return;const e=o.value.getVisibleBounds(),i=o.value.scale.x;m.forEach((n,l)=>{const s=n.x>e.x-n.width/2&&n.x<e.x+e.width+n.width/2&&n.y>e.y-n.height/2&&n.y<e.y+e.height+n.height/2;if(n.visible=s,s){const h=r.BASE_SPRITE_SIZE*i,v=r.SPRITES.TEXTURE_SIZES,d=v.find(c=>c>=h)||v[v.length-1];le(l,d)}})}async function le(e,i){const n=`${e}-${i}`;if(E.has(n)){const s=m.get(e);s&&s.texture!==E.get(n)&&(s.texture=E.get(n));return}const l=b(e,i);try{const s=await window.PIXI.Assets.load(l);E.set(n,s);const h=m.get(e);h&&(h.texture=s)}catch(s){console.warn(`Could not load texture: ${l}`,s),E.set(n,null)}}function H(){!u.value||!o.value||(u.value.renderer.resize(window.innerWidth,window.innerHeight),o.value.resize(window.innerWidth,window.innerHeight,_,R))}return de(()=>{Z("gallery2d.title"),$("pi pi-hashtag"),Y()}),he(()=>{K(),J()}),(e,i)=>(L(),U("div",Ee,[O.value?(L(),U("div",me,[D("div",ge,[ye(z(pe),{style:{width:"50px",height:"50px"},strokeWidth:"6"}),D("h4",null,W(e.$t("gallery2d.loading")),1)])])):V("",!0),C.value?(L(),ve(z(we),{key:1,severity:"error",closable:!1,class:"error-message"},{default:fe(()=>[xe(W(C.value),1)]),_:1})):V("",!0),D("div",{ref_key:"canvasContainer",ref:T,class:"gallery-canvas"},null,512)]))}}),Te=Ie(_e,[["__scopeId","data-v-56114b01"]]);export{Te as default};
