import{d as ie,e as se,u as re,f as ce,r as G,l as N,g as ue,h as de,a as he,o as fe,b as ye,_ as xe}from"./main-D5P8LRkC.js";const ve={class:"gallery-2d-container"},Ie=ie({__name:"Gallery2DView",setup(we){const r={COORDS_URL:"/gallery2d.json",BASE_SPRITE_SIZE:25,BACKGROUND:{COLOR_LIGHT:15132379,COLOR_DARK:1710618},GRID:{COLOR_LIGHT:13290186,COLOR_DARK:3355443,ALPHA_MAJOR:.5,ALPHA_MINOR:.25,MAJOR_LINE_SPACING:100,MINOR_LINE_SPACING:20},INTERACTION:{DRAG_THRESHOLD:5,PINCH_END_DELAY:200},VIEWPORT:{MIN_SCALE:.2,MAX_SCALE:75,FRICTION:.95},SPRITES:{PLACEHOLDER_COLOR:16777215,TEXTURE_SIZES:[128,256,512,1024,1536,2048]},IMAGES:{DEFAULT_SIZE:128,DEFAULT_EXT:"avif",HIGH_RES_SIZE:2048,HIGH_RES_EXT:"jpg"}};function A(e,o=r.IMAGES.DEFAULT_SIZE,t=r.IMAGES.DEFAULT_EXT){return`/gallery/${e}/${e}-${o}.${t}`}function T(e){return new Promise((o,t)=>{if(document.querySelector(`script[src="${e}"]`)){o();return}const a=document.createElement("script");a.src=e,a.async=!0,a.onload=()=>o(),a.onerror=()=>t(new Error(`Failed to load script: ${e}`)),document.head.appendChild(a)})}async function H(){await T("https://cdn.jsdelivr.net/npm/pixi.js@7.4.3/dist/pixi.min.js"),await T("https://cdn.jsdelivr.net/npm/pixi-viewport@5.1.0/dist/viewport.min.js")}const{setTitle:X,setIcon:k,resetAppBar:U}=se(),{enableSearch:z,setSearchResultsCallback:B,disableSearch:V}=re(),{showError:W,showLoading:j,closePopup:F}=ce(),O=G(null),u=N(null),i=N(null),C=G([]),E=new Map,w=new Map;let R=0,_=0,g=null,p=null,y=null;async function Z(){try{j("gallery2d.loading"),await H(),await Y(),await J(),q(),Q(),ee(),u.value.ticker.add(te),F()}catch(e){console.error("Failed to initialize gallery:",e),W("gallery2d.error",e.message,!0)}}async function K(){if(window.PIXI&&window.PIXI.Assets){const e=Array.from(E.keys()).map(o=>{const[t,a]=o.split("-");return A(t,a)});e.length>0&&await window.PIXI.Assets.unload(e)}E.clear(),w.clear(),u.value&&u.value.destroy(!0,{children:!0,texture:!1,baseTexture:!1}),g&&(g.disconnect(),g=null),window.removeEventListener("resize",b)}async function $(e){if(e.length===0){w.forEach(s=>{s.alpha=1});return}const o=new Map;e.forEach(s=>{o.set(s.imageName,s.similarity)});const t=Math.min(...o.values()),a=Math.max(...o.values());w.forEach((s,d)=>{s.alpha=(o.get(d)??0-t)/(a-t)})}async function Y(){const o=document.documentElement.classList.contains("dark")?r.BACKGROUND.COLOR_DARK:r.BACKGROUND.COLOR_LIGHT;u.value=new window.PIXI.Application({width:window.innerWidth,height:window.innerHeight,backgroundColor:o,resolution:Math.max(1,Math.min(window.devicePixelRatio||1,2)),autoDensity:!0,antialias:!0,powerPreference:"high-performance",hello:!1}),O.value&&(O.value.appendChild(u.value.view),u.value.view.style.touchAction="none"),u.value.renderer.events.moveOnAll=!0,g=new MutationObserver(()=>{if(u.value&&u.value.renderer){const t=document.documentElement.classList.contains("dark");u.value.renderer.background.color=t?r.BACKGROUND.COLOR_DARK:r.BACKGROUND.COLOR_LIGHT,y&&y()}}),g.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),window.addEventListener("resize",b)}async function J(){const o=await(await fetch(r.COORDS_URL)).json(),t=Object.entries(o).map(([n,l])=>({name:n,x:l[0],y:l[1]})),a=Math.min(...t.map(n=>n.x)),s=Math.max(...t.map(n=>n.x)),d=Math.min(...t.map(n=>n.y)),f=Math.max(...t.map(n=>n.y)),h=s-a,c=f-d,v=Math.min(window.innerWidth/h,window.innerHeight/c)*2;R=h*v,_=c*v,C.value=t.map(n=>({...n,x:(n.x-a)*v,y:(n.y-d)*v}))}function q(){i.value=new window.PIXI.Viewport({screenWidth:window.innerWidth,screenHeight:window.innerHeight,worldWidth:R,worldHeight:_,events:u.value.renderer.events}),u.value.stage.addChild(i.value);let e=!1,o=null,t=null,a=null;const s=new Map;let d=0,f=null,h=!1,c=!1;i.value.eventMode="static",i.value.hitArea=u.value.screen,i.value.on("pointerdown",n=>{if(n.pointerType==="touch")if(s.set(n.pointerId,{x:n.global.x,y:n.global.y}),s.size===2){h=!0,e=!1,a=null,i.value.plugins.pause("decelerate");const l=Array.from(s.values());d=Math.hypot(l[0].x-l[1].x,l[0].y-l[1].y),f={x:(l[0].x+l[1].x)/2,y:(l[0].y+l[1].y)/2}}else s.size===1&&!h&&(t={x:n.global.x,y:n.global.y},o={x:n.global.x,y:n.global.y},e=!1,a={x:n.global.x,y:n.global.y});else n.originalEvent.button===0&&(t={x:n.global.x,y:n.global.y},o={x:n.global.x,y:n.global.y},e=!1,a={x:n.global.x,y:n.global.y},i.value.plugins.pause("decelerate"))}),i.value.on("pointermove",n=>{if(n.pointerType==="touch"){if(!s.has(n.pointerId))return;if(s.set(n.pointerId,{x:n.global.x,y:n.global.y}),s.size===2&&h){const l=Array.from(s.values()),m=Math.hypot(l[0].x-l[1].x,l[0].y-l[1].y),I={x:(l[0].x+l[1].x)/2,y:(l[0].y+l[1].y)/2};if(d>0&&m>0&&f){const S=I.x-f.x,x=I.y-f.y;i.value.x+=S,i.value.y+=x;const ae=m/d,M=i.value.toWorld(I),le=i.value.scale.x,oe=Math.max(r.VIEWPORT.MIN_SCALE,Math.min(r.VIEWPORT.MAX_SCALE,le*ae));i.value.scale.set(oe);const D=i.value.toScreen(M.x,M.y);i.value.x+=I.x-D.x,i.value.y+=I.y-D.y,y&&y()}d=m,f=I}else s.size===1&&!h&&!c&&(!e&&t&&Math.hypot(n.global.x-t.x,n.global.y-t.y)>r.INTERACTION.DRAG_THRESHOLD&&(e=!0,a=null),e&&o&&(i.value.x+=n.global.x-o.x,i.value.y+=n.global.y-o.y,y&&y()),o={x:n.global.x,y:n.global.y})}else if(o&&t){const l={x:n.global.x,y:n.global.y};e||Math.hypot(l.x-t.x,l.y-t.y)>r.INTERACTION.DRAG_THRESHOLD&&(e=!0,a=null),e&&(i.value.x+=l.x-o.x,i.value.y+=l.y-o.y,y&&y()),o=l}});const v=n=>{if(n.pointerType==="touch"){if(!e&&!h&&!c&&a&&s.size===1){const l=P(a.x,a.y);l&&L(l)}if(s.delete(n.pointerId),s.size<2&&h&&(h=!1,d=0,f=null,c=!0,setTimeout(()=>{c=!1},r.INTERACTION.PINCH_END_DELAY),s.size===1)){const l=s.values().next().value;l&&(t={x:l.x,y:l.y},o={x:l.x,y:l.y},e=!1,a={x:l.x,y:l.y})}s.size<1&&(e&&i.value.plugins.resume("decelerate"),e=!1,o=null,t=null,a=null,c=!1)}else if(n.originalEvent.button===0){if(!e&&a){const l=P(a.x,a.y);l&&L(l)}e&&i.value.plugins.resume("decelerate"),e=!1,o=null,t=null,a=null}};i.value.on("pointerup",v),i.value.on("pointerupoutside",v),i.value.on("pointercancel",v),i.value.wheel().decelerate({friction:r.VIEWPORT.FRICTION}),i.value.clampZoom({minScale:r.VIEWPORT.MIN_SCALE,maxScale:r.VIEWPORT.MAX_SCALE}),i.value.fit(),i.value.moveCenter(R/2,_/2)}function Q(){p=new window.PIXI.Graphics,i.value.addChild(p),y=()=>{p.clear();const e=i.value.getVisibleBounds(),o=r.GRID.MAJOR_LINE_SPACING,t=r.GRID.MINOR_LINE_SPACING,a=Math.min(1,i.value.scale.x*2),s=Math.min(1,i.value.scale.x*4),f=document.documentElement.classList.contains("dark")?r.GRID.COLOR_DARK:r.GRID.COLOR_LIGHT,h=(c,v,n)=>{p.lineStyle(n/i.value.scale.x,f,v);const l=Math.floor(e.x/c)*c,m=Math.ceil((e.x+e.width)/c)*c,I=Math.floor(e.y/c)*c,S=Math.ceil((e.y+e.height)/c)*c;for(let x=l;x<m;x+=c)p.moveTo(x,I),p.lineTo(x,S);for(let x=I;x<S;x+=c)p.moveTo(l,x),p.lineTo(m,x)};s>.1&&h(t,s,r.GRID.ALPHA_MINOR),a>.05&&h(o,a,r.GRID.ALPHA_MAJOR)},i.value.on("moved",y),y()}function ee(){const e=new window.PIXI.Graphics().beginFill(r.SPRITES.PLACEHOLDER_COLOR).drawRect(0,0,128,128).endFill(),o=u.value.renderer.generateTexture(e);C.value.forEach(t=>{const a=new window.PIXI.Sprite(o);a.anchor.set(.5),a.width=r.BASE_SPRITE_SIZE,a.height=r.BASE_SPRITE_SIZE,a.x=t.x,a.y=t.y,a.eventMode="none",a.name=t.name,i.value.addChild(a),w.set(t.name,a)})}function L(e){if(e&&e.name){const o=A(e.name,r.IMAGES.HIGH_RES_SIZE,r.IMAGES.HIGH_RES_EXT);window.open(o,"_blank")}else console.warn("Click handler called with invalid sprite:",e)}function P(e,o){for(const t of w.values())if(t.getBounds().contains(e,o))return t;return null}function te(){if(!i.value)return;const e=i.value.getVisibleBounds(),o=i.value.scale.x;w.forEach((t,a)=>{const s=t.x>e.x-t.width/2&&t.x<e.x+e.width+t.width/2&&t.y>e.y-t.height/2&&t.y<e.y+e.height+t.height/2;if(t.visible=s,s){const d=r.BASE_SPRITE_SIZE*o,f=r.SPRITES.TEXTURE_SIZES,h=f.find(c=>c>=d)||f[f.length-1];ne(a,h)}})}async function ne(e,o){const t=`${e}-${o}`;if(E.has(t)){const s=w.get(e);s&&s.texture!==E.get(t)&&(s.texture=E.get(t));return}const a=A(e,o);try{const s=await window.PIXI.Assets.load(a);E.set(t,s);const d=w.get(e);d&&(d.texture=s)}catch(s){console.warn(`Could not load texture: ${a}`,s),E.set(t,null)}}function b(){!u.value||!i.value||(u.value.renderer.resize(window.innerWidth,window.innerHeight),i.value.resize(window.innerWidth,window.innerHeight,R,_))}return ue(()=>{X("gallery2d.title"),k("pi pi-hashtag"),Z(),z(),B($)}),de(()=>{U(),V(),K()}),(e,o)=>(fe(),he("div",ve,[ye("div",{ref_key:"canvasContainer",ref:O,class:"gallery-canvas"},null,512)]))}}),Ee=xe(Ie,[["__scopeId","data-v-1e6c3e94"]]);export{Ee as default};
